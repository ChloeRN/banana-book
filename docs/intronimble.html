<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Chapter 2 NIMBLE tutorial | Bayesian Analysis of Capture-Recapture Data with Hidden Markov Models</title>
<meta name="author" content="Olivier Gimenez">
<meta name="description" content="2.1 Introduction In this second chapter, you will get familiar with NIMBLE, an R package that implements up-to-date MCMC algorithms for fitting complex models. NIMBLE spares you from coding the...">
<meta name="generator" content="bookdown 0.23 with bs4_book()">
<meta property="og:title" content="Chapter 2 NIMBLE tutorial | Bayesian Analysis of Capture-Recapture Data with Hidden Markov Models">
<meta property="og:type" content="book">
<meta property="og:url" content="https://oliviergimenez.github.io/bayesian-cr-workshop/intronimble.html">
<meta property="og:description" content="2.1 Introduction In this second chapter, you will get familiar with NIMBLE, an R package that implements up-to-date MCMC algorithms for fitting complex models. NIMBLE spares you from coding the...">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Chapter 2 NIMBLE tutorial | Bayesian Analysis of Capture-Recapture Data with Hidden Markov Models">
<meta name="twitter:description" content="2.1 Introduction In this second chapter, you will get familiar with NIMBLE, an R package that implements up-to-date MCMC algorithms for fitting complex models. NIMBLE spares you from coding the...">
<!-- JS --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://kit.fontawesome.com/6ecbd6c532.js" crossorigin="anonymous"></script><script src="libs/header-attrs-2.11/header-attrs.js"></script><script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="libs/bootstrap-4.6.0/bootstrap.min.css" rel="stylesheet">
<script src="libs/bootstrap-4.6.0/bootstrap.bundle.min.js"></script><script src="libs/bs3compat-0.3.1/transition.js"></script><script src="libs/bs3compat-0.3.1/tabs.js"></script><script src="libs/bs3compat-0.3.1/bs3compat.js"></script><link href="libs/bs4_book-1.0.0/bs4_book.css" rel="stylesheet">
<script src="libs/bs4_book-1.0.0/bs4_book.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- CSS --><link rel="stylesheet" href="bs4_style.css">
</head>
<body data-spy="scroll" data-target="#toc">

<div class="container-fluid">
<div class="row">
  <header class="col-sm-12 col-lg-3 sidebar sidebar-book"><a class="sr-only sr-only-focusable" href="#content">Skip to main content</a>

    <div class="d-flex align-items-start justify-content-between">
      <h1>
        <a href="index.html" title="Theory and Case Studies in R">Bayesian Analysis of Capture-Recapture Data with Hidden Markov Models</a>:
        <small class="text-muted">Theory and Case Studies in R</small>
      </h1>
      <button class="btn btn-outline-primary d-lg-none ml-2 mt-1" type="button" data-toggle="collapse" data-target="#main-nav" aria-expanded="true" aria-controls="main-nav"><i class="fas fa-bars"></i><span class="sr-only">Show table of contents</span></button>
    </div>

    <div id="main-nav" class="collapse-lg">
      <form role="search">
        <input id="search" class="form-control" type="search" placeholder="Search" aria-label="Search">
</form>

      <nav aria-label="Table of contents"><h2>Table of contents</h2>
        <ul class="book-toc list-unstyled">
<li><a class="" href="index.html">Welcome</a></li>
<li><a class="" href="preface.html">Preface</a></li>
<li><a class="" href="about-the-author.html">About the author</a></li>
<li class="book-part">I. Fundations</li>
<li><a class="" href="introduction.html">Introduction</a></li>
<li><a class="" href="crashcourse.html"><span class="header-section-number">1</span> Bayesian statistics &amp; MCMC</a></li>
<li><a class="active" href="intronimble.html"><span class="header-section-number">2</span> NIMBLE tutorial</a></li>
<li><a class="" href="hmmcapturerecapture.html"><span class="header-section-number">3</span> Hidden Markov models</a></li>
<li class="book-part">II. Transitions</li>
<li><a class="" href="introduction-3.html">Introduction</a></li>
<li><a class="" href="survival.html"><span class="header-section-number">4</span> Survival</a></li>
<li><a class="" href="covariates.html"><span class="header-section-number">5</span> Covariates</a></li>
<li><a class="" href="dispersal.html"><span class="header-section-number">6</span> Dispersal</a></li>
<li><a class="" href="model-selection.html"><span class="header-section-number">7</span> Model selection and validation</a></li>
<li class="book-part">III. States</li>
<li><a class="" href="introduction-4.html">Introduction</a></li>
<li><a class="" href="uncertainty.html"><span class="header-section-number">8</span> State uncertainty</a></li>
<li><a class="" href="hsmm.html"><span class="header-section-number">9</span> Hidden semi-Markov models</a></li>
<li class="book-part">IV. Case studies</li>
<li><a class="" href="introduction-5.html">Introduction</a></li>
<li><a class="" href="tradeoffs.html"><span class="header-section-number">10</span> Life history theory</a></li>
<li><a class="" href="abundance.html"><span class="header-section-number">11</span> Abundance</a></li>
<li><a class="" href="stopover.html"><span class="header-section-number">12</span> Stopover duration</a></li>
<li><a class="" href="individual-dependence.html"><span class="header-section-number">13</span> Individual dependence</a></li>
<li class="book-part">V. Conclusion</li>
<li><a class="" href="take-home-messages.html">Take-home messages</a></li>
<li><a class="" href="faq.html">FAQ</a></li>
<li><a class="" href="references.html">References</a></li>
</ul>

        <div class="book-extra">
          <p><a id="book-repo" href="https://github.com/oliviergimenez/banana-book">View book source <i class="fab fa-github"></i></a></p>
        </div>
      </nav>
</div>
  </header><main class="col-sm-12 col-md-9 col-lg-7" id="content"><div id="intronimble" class="section level1" number="2">
<h1>
<span class="header-section-number">2</span> NIMBLE tutorial<a class="anchor" aria-label="anchor" href="#intronimble"><i class="fas fa-link"></i></a>
</h1>
<div id="introduction-2" class="section level2" number="2.1">
<h2>
<span class="header-section-number">2.1</span> Introduction<a class="anchor" aria-label="anchor" href="#introduction-2"><i class="fas fa-link"></i></a>
</h2>
<p>In this second chapter, you will get familiar with NIMBLE, an R package that implements up-to-date MCMC algorithms for fitting complex models. NIMBLE spares you from coding the MCMC algorithms by hand, and requires only the specification of a likelihood and priors for model parameters. We will illustrate NIMBLE main features with a simple example, but the ideas hold for other problems.</p>
</div>
<div id="what-is-nimble" class="section level2" number="2.2">
<h2>
<span class="header-section-number">2.2</span> What is NIMBLE?<a class="anchor" aria-label="anchor" href="#what-is-nimble"><i class="fas fa-link"></i></a>
</h2>
<p>NIMBLE stands for <strong>N</strong>umerical <strong>I</strong>nference for statistical <strong>M</strong>odels using <strong>B</strong>ayesian and <strong>L</strong>ikelihood <strong>E</strong>stimation. Briefly speaking, NIMBLE is an R package that implements for you MCMC algorithms to generate samples from the posterior distribution of model parameters. Freed from the burden of coding your own MCMC algorithms, you only have to specify a likelihood and priors to apply the Bayes theorem. To do so, NIMBLE uses a syntax very similar to the R syntax, which should make your life easier. This so-called BUGS language is also used by other programs like WinBUGS, OpenBUGS, and JAGS.</p>
<p>So why use NIMBLE you may ask? The short answer is that NIMBLE is capable of so much more! First, you will work from within R, but in the background NIMBLE will translate your code in C++ for (in general) faster computation. Second, NIMBLE extends the BUGS language for writing new functions and statistical distributions of your own, or borrow those written by others. Third, NIMBLE gives you full control of the MCMC samplers, and you may pick other algorithms than the defaults. Fourth, NIMBLE comes with a library of numerical methods other than MCMC algorithms, including sequential Monte Carlo (for particle filtering) and Monte Carlo Expectation Maximization (for maximum likelihood). Last but not least, the development team is friendly and helpful, and based on users’ feedbacks, NIMBLE folks work constantly at improving the package capabilities.</p>
</div>
<div id="running-nimble" class="section level2" number="2.3">
<h2>
<span class="header-section-number">2.3</span> Running NIMBLE<a class="anchor" aria-label="anchor" href="#running-nimble"><i class="fas fa-link"></i></a>
</h2>
<div id="the-basics" class="section level3" number="2.3.1">
<h3>
<span class="header-section-number">2.3.1</span> The basics<a class="anchor" aria-label="anchor" href="#the-basics"><i class="fas fa-link"></i></a>
</h3>
<p>To run NIMBLE, you will need to:<br>
1. Build a model consisting of a likelihood and priors.<br>
2. Read in some data.<br>
3. Specify parameters you want to make inference about.<br>
4. Pick initial values for parameters to be estimated (for each chain).<br>
5. Provide MCMC details namely the number of chains, the length of the burn-in period and the number of iterations following burn-in.</p>
<p>First things first, let’s not forget to load the <code>nimble</code> package:</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://r-nimble.org">nimble</a></span><span class="op">)</span></code></pre></div>
<p>Now let’s go back to our example on animal survival from the previous chapter. First step is to build our model by specifying the binomial likelihood and a uniform prior on survival probability <span class="math inline">\(\theta\)</span>. We use the <code><a href="https://rdrr.io/pkg/nimble/man/nimbleCode.html">nimbleCode()</a></code> function and write code within curly brackets:</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">model</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/nimble/man/nimbleCode.html">nimbleCode</a></span><span class="op">(</span><span class="op">{</span>
  <span class="co"># likelihood</span>
  <span class="va">survived</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/stats/Binomial.html">dbinom</a></span><span class="op">(</span><span class="va">theta</span>, <span class="va">released</span><span class="op">)</span>
  <span class="co"># prior</span>
  <span class="va">theta</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">dunif</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span>
<span class="op">}</span><span class="op">)</span></code></pre></div>
<p>You may check that the <code>model</code> R object contains your code:</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">model</span>
<span class="co">## {</span>
<span class="co">##     survived ~ dbinom(theta, released)</span>
<span class="co">##     theta ~ dunif(0, 1)</span>
<span class="co">## }</span></code></pre></div>
<p>In the code above, <code>survived</code> and <code>released</code> are known data, only <code>theta</code> needs to be estimated. The line <code>survived ~ dbinom(theta, released)</code> says that the number of successes or animals that have survived over winter <code>survived</code> is distributed as (that’s the <code><a href="https://rdrr.io/r/base/tilde.html">~</a></code>) as a binomial with <code>released</code> trials and probability of success or survival <code>theta</code>. Then <code>theta ~ dunif(0, 1)</code> assigns a uniform between 0 and 1 as a prior distribution to the survival probability. This is all you need, a likelihood and priors for model parameters, NIMBLE knows the Bayes theorem.</p>
<p>A few comments:</p>
<ul>
<li><p>Most usual distributions are available in NIMBLE. We will use later in the book <code>dbeta</code>, <code>dmultinom</code> and <code>dnorm</code> among others. If you cannot find what you need in NIMBLE, you can write your own distribution as illustrated in Section <a href="intronimble.html#write-your-own-distribution">2.5.6</a>.</p></li>
<li><p>It does not matter in what order you write each line of code, NIMBLE uses what is called a declarative language for building models. In brief, you write code that tells NIMBLE what you want to achieve, and not how to get there. In contrast, an imperative language requires that you write what you want your program to do step by step.</p></li>
<li><p><strong>“Some terminology to introduce. A node (sometimes called a vertex) holds one value, which may be a scalar or a vector. Edges define the relationships between nodes. A huge variety of statistical models can be thought of as graphs. Each relation defines a node in the model.” “The node on the left of a relation is defined in terms of other nodes – referred to as parent nodes – that appear on the right hand side. Taken together, the nodes in the model form a directed acyclic graph (with the parent/child relationships represented as directed edges). The very top-level nodes in the graph, with no parents, are constant nodes, which are defined either in the model definition (e.g. 1.0E-3), or in the data when the model is compiled (e.g. x[1]).”</strong></p></li>
</ul>
<p>Second step in our workflow is to read in some data. We use a list in which each component corresponds to a known variable in the model:</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">my.data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>released <span class="op">=</span> <span class="fl">57</span>, survived <span class="op">=</span> <span class="fl">19</span><span class="op">)</span></code></pre></div>
<p>Third step is to tell NIMBLE which parameters in your model you would like to keep track of, in other words the parameters you are interested in. In our simple model there is a single parameter <code>theta</code> for survival so you do not have much of a choice. However, in general, you will have several parameters, including some of no prime interest, and having the control on verbosity will prove handy.</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">parameters.to.save</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/nimble/man/nimble-R-functions.html">c</a></span><span class="op">(</span><span class="st">"theta"</span><span class="op">)</span></code></pre></div>
<p>Fourth step is to specify initial values for all model parameters. To make sure that the MCMC algorithm explores the posterior distribution, we start different chains with different parameter values. You can specify initial values for each chain in a list and put them in yet another list:</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">init1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>theta <span class="op">=</span> <span class="fl">0.1</span><span class="op">)</span>
<span class="va">init2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>theta <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span>
<span class="va">init3</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>theta <span class="op">=</span> <span class="fl">0.9</span><span class="op">)</span>
<span class="va">initial.values</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="va">init1</span>, <span class="va">init2</span>, <span class="va">init3</span><span class="op">)</span>
<span class="va">initial.values</span>
<span class="co">## [[1]]</span>
<span class="co">## [[1]]$theta</span>
<span class="co">## [1] 0.1</span>
<span class="co">## </span>
<span class="co">## </span>
<span class="co">## [[2]]</span>
<span class="co">## [[2]]$theta</span>
<span class="co">## [1] 0.5</span>
<span class="co">## </span>
<span class="co">## </span>
<span class="co">## [[3]]</span>
<span class="co">## [[3]]$theta</span>
<span class="co">## [1] 0.9</span></code></pre></div>
<p>Alternatively, you may write a simple R function that generates random initial values:</p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">initial.values</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>theta <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">0</span>,<span class="fl">1</span><span class="op">)</span><span class="op">)</span>
<span class="fu">initial.values</span><span class="op">(</span><span class="op">)</span>
<span class="co">## $theta</span>
<span class="co">## [1] 0.2046</span></code></pre></div>
<p>Firth and last step, you need to tell NIMBLE the number of chains to run <code>n.chain</code>, how long the burn-in period should be <code>n.burnin</code> and the number of iterations to be used for posterior inference, that is following the burn-in period. In NIMBLE, you specify the total number of iterations <code>n.iter</code>, so that the number of posterior samples per chain is <code>n.iter - n.burnin</code>. <strong>To be smoothed: these are R objects, not nimbleMCMC() arguments; also thinning in the formula, but by default is 1 and we do not use it, so just ignore.</strong></p>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">n.iter</span> <span class="op">&lt;-</span> <span class="fl">5000</span>
<span class="va">n.burnin</span> <span class="op">&lt;-</span> <span class="fl">1000</span>
<span class="va">n.chains</span> <span class="op">&lt;-</span> <span class="fl">3</span></code></pre></div>
<p>We now have all the ingredients to run model, that is to sample in the posterior distribution of model parameters using MCMC simulations. This is accomplished using function <code><a href="https://rdrr.io/pkg/nimble/man/nimbleMCMC.html">nimbleMCMC()</a></code>:</p>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">mcmc.output</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/nimble/man/nimbleMCMC.html">nimbleMCMC</a></span><span class="op">(</span>code <span class="op">=</span> <span class="va">model</span>,
                          data <span class="op">=</span> <span class="va">my.data</span>,
                          inits <span class="op">=</span> <span class="va">initial.values</span>,
                          monitors <span class="op">=</span> <span class="va">parameters.to.save</span>,
                          niter <span class="op">=</span> <span class="va">n.iter</span>,
                          nburnin <span class="op">=</span> <span class="va">n.burnin</span>,
                          nchains <span class="op">=</span> <span class="va">n.chains</span><span class="op">)</span>
<span class="co">## |-------------|-------------|-------------|-------------|</span>
<span class="co">## |-------------------------------------------------------|</span>
<span class="co">## |-------------|-------------|-------------|-------------|</span>
<span class="co">## |-------------------------------------------------------|</span>
<span class="co">## |-------------|-------------|-------------|-------------|</span>
<span class="co">## |-------------------------------------------------------|</span></code></pre></div>
<p>NIMBLE goes through several steps that we will explain later on. <strong>Say a few words on the messages we receive. Comment on arguments of the function: E.g. ProgressBar can be supressed if too depressing.</strong></p>

<div class="rmdnote">
Repeat workflow. Main steps. Likelihood and prior for parameters.
</div>
</div>
<div id="into-specifics" class="section level3" number="2.3.2">
<h3>
<span class="header-section-number">2.3.2</span> Into specifics<a class="anchor" aria-label="anchor" href="#into-specifics"><i class="fas fa-link"></i></a>
</h3>
<p>Ici on reprend le modèle simple du dessus, et on l’exprime un peu différemment pour illustrer qqs autres features de NIMBLE: i) loops, ii) distinction between constants and data, iii) stochastic vs deterministic nodes, and edges. The binomial is just a sum of Bernoulli outcomes. Like flipping a coin for each individual and get a survivor with prob theta. Here survived is a Bernoulli random variable taking value 1 if animal survived, and 0 otherwise. <strong>Voir dans annexe Hobbs</strong>. E.g. <code>survived[1] ~ dbern(theta)</code> up to <code>survived[59] ~ dbern(theta)</code>. Likelihood contribution of individuals. Loops is the product. Iid. Instead of duplicating the same line of code <code>survived[i] ~ dbern(theta)</code> we use a loop.</p>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">model</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/nimble/man/nimbleCode.html">nimbleCode</a></span><span class="op">(</span><span class="op">{</span>
  <span class="co"># likelihood</span>
  <span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">released</span><span class="op">)</span><span class="op">{</span>
    <span class="va">survived</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">~</span> <span class="fu">dbern</span><span class="op">(</span><span class="va">theta</span><span class="op">)</span>
  <span class="op">}</span>
  <span class="co"># prior</span>
  <span class="va">theta</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">dunif</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span>
  <span class="va">life_expectancy</span> <span class="op">&lt;-</span> <span class="op">-</span><span class="fl">1</span><span class="op">/</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="va">theta</span><span class="op">)</span>
<span class="op">}</span><span class="op">)</span></code></pre></div>
<p>Note the <code>life_expectancy &lt;- -1/log(theta)</code> which gives life expectancy. <strong>Relations can be of two types. We have seen earlier a stochastic relation (<code><a href="https://rdrr.io/r/base/tilde.html">~</a></code>) that defines a stochastic node, representing a random variable in the model. A deterministic relation (<code><a href="https://rdrr.io/r/base/assignOps.html">&lt;-</a></code>) defines a deterministic node, the value of which is determined exactly by the values of its parents.</strong></p>
<!-- Distinguish constants and data. To Nimble, not all "data" is data... -->
<!-- ```{r} -->
<!-- my.constants <- list(released = 57) -->
<!-- my.data <- list(survived = 19) -->
<!-- ``` -->
<!-- **Constants**: -->
<!-- + Can never be changed -->
<!-- + Must be provided when a model is defined (part of the model structure) -->
<!-- + E.g. vector of known index values, variables used to define for-loops, etc. -->
<!-- After defining the model code, we should define the constants, initial values and data list. Compared to WinBUGS and JAGS, data and initial values can be defined in the same way, while ‘constants’ is a new list that contains the values that would not change, including the variables that define for-loop indices. In our settings, the lists of data, constants and initial values are given as follows: -->
<!-- **Data**: -->
<!-- + Can be changed without re-building the model -->
<!-- + Can be (re-)simulated within a model -->
<!-- + E.g. stuff that *only* appears to the left of a "~" -->
<!-- For computational efficiency, better to specify as much as possible as constants. NIMBLE will help you with this! -->
<!-- ```{r, eval = FALSE} -->
<!-- mcmc.output <- nimbleMCMC(code = model, -->
<!--                           data = my.data, -->
<!--                           constants = my.constants, -->
<!--                           inits = initial.values, -->
<!--                           monitors = parameters.to.save, -->
<!--                           niter = n.iter, -->
<!--                           nburnin = n.burnin, -->
<!--                           nchains = n.chains) -->
<!-- ``` -->
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">my.data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>survived <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/nimble/man/nimble-R-functions.html">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/nimble/man/nimble-R-functions.html">rep</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">19</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/pkg/nimble/man/nimble-R-functions.html">rep</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">57</span><span class="op">-</span><span class="fl">19</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
<span class="va">my.constants</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>released <span class="op">=</span> <span class="fl">57</span><span class="op">)</span></code></pre></div>
<p>The rest is the same. Steps 3, 4 and 5.</p>
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">parameters.to.save</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/nimble/man/nimble-R-functions.html">c</a></span><span class="op">(</span><span class="st">"theta"</span>, <span class="st">"life_expectancy"</span><span class="op">)</span>
<span class="va">initial.values</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>theta <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">0</span>,<span class="fl">1</span><span class="op">)</span><span class="op">)</span>
<span class="va">n.iter</span> <span class="op">&lt;-</span> <span class="fl">5000</span>
<span class="va">n.burnin</span> <span class="op">&lt;-</span> <span class="fl">1000</span>
<span class="va">n.chains</span> <span class="op">&lt;-</span> <span class="fl">3</span></code></pre></div>
<p>Run model, add argument <code>constants = my.constants</code>.</p>
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">mcmc.output</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/nimble/man/nimbleMCMC.html">nimbleMCMC</a></span><span class="op">(</span>code <span class="op">=</span> <span class="va">model</span>,
                          data <span class="op">=</span> <span class="va">my.data</span>,
                          constants <span class="op">=</span> <span class="va">my.constants</span>,
                          inits <span class="op">=</span> <span class="va">initial.values</span>,
                          monitors <span class="op">=</span> <span class="va">parameters.to.save</span>,
                          niter <span class="op">=</span> <span class="va">n.iter</span>,
                          nburnin <span class="op">=</span> <span class="va">n.burnin</span>,
                          nchains <span class="op">=</span> <span class="va">n.chains</span><span class="op">)</span>
<span class="co">## |-------------|-------------|-------------|-------------|</span>
<span class="co">## |-------------------------------------------------------|</span>
<span class="co">## |-------------|-------------|-------------|-------------|</span>
<span class="co">## |-------------------------------------------------------|</span>
<span class="co">## |-------------|-------------|-------------|-------------|</span>
<span class="co">## |-------------------------------------------------------|</span></code></pre></div>
<p>Life expectancy directly monitored. But you can also calculate it outside NIMBLE by hand:</p>
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">theta</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/nimble/man/nimble-R-functions.html">c</a></span><span class="op">(</span><span class="va">mcmc.output</span><span class="op">$</span><span class="va">chain1</span><span class="op">[</span>,<span class="st">'theta'</span><span class="op">]</span>, 
  <span class="va">mcmc.output</span><span class="op">$</span><span class="va">chain2</span><span class="op">[</span>,<span class="st">'theta'</span><span class="op">]</span>,
  <span class="va">mcmc.output</span><span class="op">$</span><span class="va">chain3</span><span class="op">[</span>,<span class="st">'theta'</span><span class="op">]</span><span class="op">)</span>
<span class="va">lambda</span> <span class="op">&lt;-</span> <span class="op">-</span><span class="fl">1</span><span class="op">/</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="va">theta</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">lambda</span><span class="op">)</span>
<span class="co">## [1] 1.0894 0.8205 0.8205 0.7621 0.7621 0.8044</span></code></pre></div>
<p>Visualise:</p>
<div class="sourceCode" id="cb31"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">lambda</span> <span class="op">%&gt;%</span>
  <span class="fu">as_tibble</span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">geom_histogram</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">value</span><span class="op">)</span>, color <span class="op">=</span> <span class="st">"white"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">labs</span><span class="op">(</span>x <span class="op">=</span> <span class="st">"life expectancy"</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="banana-book_files/figure-html/unnamed-chunk-44-1.png" width="672"></div>
</div>
</div>
<div id="making-sense-of-the-mcmc-outputs" class="section level2" number="2.4">
<h2>
<span class="header-section-number">2.4</span> Making sense of the MCMC outputs<a class="anchor" aria-label="anchor" href="#making-sense-of-the-mcmc-outputs"><i class="fas fa-link"></i></a>
</h2>
<div id="post-process-mcmc-outputs-by-hand" class="section level3" number="2.4.1">
<h3>
<span class="header-section-number">2.4.1</span> Post-process MCMC outputs by hand<a class="anchor" aria-label="anchor" href="#post-process-mcmc-outputs-by-hand"><i class="fas fa-link"></i></a>
</h3>
<p>Inspect what’s in there:</p>
<div class="sourceCode" id="cb32"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/utils/str.html">str</a></span><span class="op">(</span><span class="va">mcmc.output</span><span class="op">)</span>
<span class="co">## List of 3</span>
<span class="co">##  $ chain1: num [1:4000, 1:2] 1.089 0.82 0.82 0.762 0.762 ...</span>
<span class="co">##   ..- attr(*, "dimnames")=List of 2</span>
<span class="co">##   .. ..$ : NULL</span>
<span class="co">##   .. ..$ : chr [1:2] "life_expectancy" "theta"</span>
<span class="co">##  $ chain2: num [1:4000, 1:2] 1.283 0.806 0.827 0.827 0.827 ...</span>
<span class="co">##   ..- attr(*, "dimnames")=List of 2</span>
<span class="co">##   .. ..$ : NULL</span>
<span class="co">##   .. ..$ : chr [1:2] "life_expectancy" "theta"</span>
<span class="co">##  $ chain3: num [1:4000, 1:2] 0.833 0.976 1.08 0.767 0.767 ...</span>
<span class="co">##   ..- attr(*, "dimnames")=List of 2</span>
<span class="co">##   .. ..$ : NULL</span>
<span class="co">##   .. ..$ : chr [1:2] "life_expectancy" "theta"</span></code></pre></div>
<div class="sourceCode" id="cb33"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">mcmc.output</span><span class="op">$</span><span class="va">chain1</span><span class="op">)</span>
<span class="co">##      life_expectancy  theta</span>
<span class="co">## [1,]          1.0894 0.3994</span>
<span class="co">## [2,]          0.8205 0.2956</span>
<span class="co">## [3,]          0.8205 0.2956</span>
<span class="co">## [4,]          0.7621 0.2692</span>
<span class="co">## [5,]          0.7621 0.2692</span>
<span class="co">## [6,]          0.8044 0.2885</span></code></pre></div>
<div class="inline-figure"><img src="banana-book_files/figure-html/unnamed-chunk-47-1.png" width="672"></div>
</div>
<div id="post-process-mcmc-outputs-without-pain" class="section level3" number="2.4.2">
<h3>
<span class="header-section-number">2.4.2</span> Post-process MCMC outputs without pain<a class="anchor" aria-label="anchor" href="#post-process-mcmc-outputs-without-pain"><i class="fas fa-link"></i></a>
</h3>
<p>We use MCMCvis, but there are other perfectly valid options out there like ggmcmc and basicMCMCplots.</p>
<p>Numerical summaries.</p>
<div class="sourceCode" id="cb34"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/caseyyoungflesh/MCMCvis">MCMCvis</a></span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/pkg/MCMCvis/man/MCMCsummary.html">MCMCsummary</a></span><span class="op">(</span><span class="va">mcmc.output</span>, round <span class="op">=</span> <span class="fl">2</span><span class="op">)</span>
<span class="co">##                 mean   sd 2.5%  50% 97.5% Rhat n.eff</span>
<span class="co">## life_expectancy 0.93 0.16 0.66 0.92  1.30    1  2909</span>
<span class="co">## theta           0.34 0.06 0.22 0.34  0.46    1  2714</span></code></pre></div>
<p>Trace and posterior density</p>
<div class="sourceCode" id="cb35"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/pkg/MCMCvis/man/MCMCtrace.html">MCMCtrace</a></span><span class="op">(</span><span class="va">mcmc.output</span>,
          pdf <span class="op">=</span> <span class="cn">FALSE</span>,
          params <span class="op">=</span> <span class="st">"theta"</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="banana-book_files/figure-html/unnamed-chunk-49-1.png" width="672"></div>
<div class="sourceCode" id="cb36"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/pkg/MCMCvis/man/MCMCtrace.html">MCMCtrace</a></span><span class="op">(</span><span class="va">mcmc.output</span>,
          pdf <span class="op">=</span> <span class="cn">FALSE</span>,
          ind <span class="op">=</span> <span class="cn">TRUE</span>,
          Rhat <span class="op">=</span> <span class="cn">TRUE</span>,
          n.eff <span class="op">=</span> <span class="cn">TRUE</span>,
          params <span class="op">=</span> <span class="st">"theta"</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="banana-book_files/figure-html/unnamed-chunk-50-1.png" width="672"></div>
</div>
</div>
<div id="advanced-stuff" class="section level2" number="2.5">
<h2>
<span class="header-section-number">2.5</span> Advanced stuff<a class="anchor" aria-label="anchor" href="#advanced-stuff"><i class="fas fa-link"></i></a>
</h2>
<p><strong>Move material from Speed slides here. Say that this section can be skipped.</strong></p>
<div id="vectorization" class="section level3" number="2.5.1">
<h3>
<span class="header-section-number">2.5.1</span> Vectorization<a class="anchor" aria-label="anchor" href="#vectorization"><i class="fas fa-link"></i></a>
</h3>
<div class="sourceCode" id="cb37"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># JAGS (&amp; Nimble)</span>
<span class="kw">for</span><span class="op">(</span><span class="va">t</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">Tmax</span><span class="op">)</span><span class="op">{</span>
  <span class="va">x</span><span class="op">[</span><span class="va">t</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">Mu.x</span> <span class="op">+</span> <span class="va">epsilon</span><span class="op">[</span><span class="va">t</span><span class="op">]</span>
<span class="op">}</span>

<span class="co"># Nimble</span>
<span class="va">x</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="va">Tmax</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">Mu.x</span> <span class="op">+</span> <span class="va">epsilon</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="va">Tmax</span><span class="op">]</span></code></pre></div>
<div class="sourceCode" id="cb38"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">model</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/nimble/man/nimbleCode.html">nimbleCode</a></span><span class="op">(</span><span class="op">{</span>
  <span class="co"># likelihood</span>
  <span class="va">survived</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="va">released</span><span class="op">]</span> <span class="op">~</span> <span class="fu">dbern</span><span class="op">(</span><span class="va">theta</span><span class="op">)</span>
  <span class="co"># prior</span>
  <span class="va">theta</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">dunif</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span>
  <span class="va">life_expectancy</span> <span class="op">&lt;-</span> <span class="op">-</span><span class="fl">1</span><span class="op">/</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="va">theta</span><span class="op">)</span>
<span class="op">}</span><span class="op">)</span></code></pre></div>
</div>
<div id="flexible-specification-of-distributions" class="section level3" number="2.5.2">
<h3>
<span class="header-section-number">2.5.2</span> Flexible specification of distributions<a class="anchor" aria-label="anchor" href="#flexible-specification-of-distributions"><i class="fas fa-link"></i></a>
</h3>
<div class="sourceCode" id="cb39"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># JAGS (&amp; Nimble)</span>
<span class="kw">for</span><span class="op">(</span><span class="va">t</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">Tmax</span><span class="op">)</span><span class="op">{</span>
  <span class="va">epsilon</span><span class="op">[</span><span class="va">t</span><span class="op">]</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">dnorm</a></span><span class="op">(</span><span class="fl">0</span>, <span class="va">tau</span><span class="op">)</span>
<span class="op">}</span>
<span class="va">tau</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/nimble/man/nimble-math.html">pow</a></span><span class="op">(</span><span class="va">sigma</span>, <span class="op">-</span><span class="fl">2</span><span class="op">)</span>
<span class="va">sigma</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">dunif</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">5</span><span class="op">)</span>

<span class="co"># Nimble</span>
<span class="kw">for</span><span class="op">(</span><span class="va">t</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">Tmax</span><span class="op">)</span><span class="op">{</span>
  <span class="va">epsilon</span><span class="op">[</span><span class="va">t</span><span class="op">]</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">dnorm</a></span><span class="op">(</span><span class="fl">0</span>, sd <span class="op">=</span> <span class="va">sigma</span><span class="op">)</span>
<span class="op">}</span>
<span class="va">sigma</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">dunif</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">5</span><span class="op">)</span></code></pre></div>
<ul>
<li>Your own functions and distributions</li>
</ul>
<div class="sourceCode" id="cb40"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">x</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="va">Tmax</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu">myNimbleFunction</span><span class="op">(</span>a <span class="op">=</span> <span class="va">Mu.x</span>, b <span class="op">=</span> <span class="va">epsilon</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="va">Tmax</span><span class="op">]</span><span class="op">)</span></code></pre></div>
<div class="sourceCode" id="cb41"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">sigma</span> <span class="op">~</span> <span class="fu">dCustomDistr</span><span class="op">(</span>c <span class="op">=</span> <span class="fl">0.5</span>, z <span class="op">=</span> <span class="fl">10</span><span class="op">)</span></code></pre></div>
<ul>
<li>The end of empty indices</li>
</ul>
<div class="sourceCode" id="cb42"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># JAGS</span>
<span class="va">sum.x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">x</span><span class="op">[</span><span class="op">]</span><span class="op">)</span>

<span class="co"># Nimble</span>
<span class="va">sum.x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">x</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="va">Tmax</span><span class="op">]</span><span class="op">)</span></code></pre></div>
</div>
<div id="behind-the-hood" class="section level3" number="2.5.3">
<h3>
<span class="header-section-number">2.5.3</span> Behind the hood<a class="anchor" aria-label="anchor" href="#behind-the-hood"><i class="fas fa-link"></i></a>
</h3>
<p>Our workflow so far.</p>
<div class="sourceCode" id="cb43"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">knitr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/knitr/man/include_graphics.html">include_graphics</a></span><span class="op">(</span><span class="st">"images/nimble_workflow_sofar.png"</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="images/nimble_workflow_sofar.png" width="1497"></div>
<p>But <code>nimble</code> gives full access to the MCMC engine</p>
<div class="sourceCode" id="cb44"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">knitr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/knitr/man/include_graphics.html">include_graphics</a></span><span class="op">(</span><span class="st">"images/nimble_workflow.png"</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="images/nimble_workflow.png" width="1497"></div>
<p>The <code><a href="https://rdrr.io/pkg/nimble/man/nimbleMCMC.html">nimbleMCMC()</a></code> interface runs the “default” MCMC, which precludes any customization of the MCMC sampling algorithms. This is fine for most use, but in some situations useful to know what’s behind the hood. The workflow to use is: <code><a href="https://rdrr.io/pkg/nimble/man/nimbleModel.html">nimbleModel()</a></code>, <code><a href="https://rdrr.io/pkg/nimble/man/configureMCMC.html">configureMCMC()</a></code>, <code><a href="https://rdrr.io/pkg/nimble/man/buildMCMC.html">buildMCMC()</a></code>, <code><a href="https://rdrr.io/pkg/nimble/man/compileNimble.html">compileNimble()</a></code> and <code><a href="https://rdrr.io/pkg/nimble/man/runMCMC.html">runMCMC()</a></code>. Why is it useful? <strong>Go through example again. Show how to debug. Move stuff from Speed here.</strong></p>
</div>
<div id="call-r-functions-within-nimble" class="section level3" number="2.5.4">
<h3>
<span class="header-section-number">2.5.4</span> Call R functions within NIMBLE<a class="anchor" aria-label="anchor" href="#call-r-functions-within-nimble"><i class="fas fa-link"></i></a>
</h3>
<p>Say we want an R function that adds 2 to every value in a vector.</p>
<div class="sourceCode" id="cb45"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">calculate_life_expectancy</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span>
   <span class="op">-</span><span class="fl">1</span><span class="op">/</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span>
<span class="op">}</span></code></pre></div>
<p>This function can be any function from R packages, easier to call with <code>name_package::my_function()</code>.</p>
<p>Now a wrapper.</p>
<div class="sourceCode" id="cb46"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">Rcalculate_life_expectancy</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/nimble/man/nimbleRcall.html">nimbleRcall</a></span><span class="op">(</span><span class="kw">function</span><span class="op">(</span><span class="va">x</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/double.html">double</a></span><span class="op">(</span><span class="fl">0</span><span class="op">)</span><span class="op">)</span><span class="op">{</span><span class="op">}</span>, 
                     Rfun <span class="op">=</span> <span class="st">'calculate_life_expectancy'</span>,
                     returnType <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/double.html">double</a></span><span class="op">(</span><span class="fl">0</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p><strong>Explain format. double(0), double(1), double(2). Best advice is to have a look to other functions.</strong></p>
<div class="sourceCode" id="cb47"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">model</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/nimble/man/nimbleCode.html">nimbleCode</a></span><span class="op">(</span><span class="op">{</span>
  <span class="co"># likelihood</span>
  <span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">released</span><span class="op">)</span><span class="op">{</span>
    <span class="va">survived</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">~</span> <span class="fu">dbern</span><span class="op">(</span><span class="va">theta</span><span class="op">)</span>
  <span class="op">}</span>
  <span class="co"># prior</span>
  <span class="va">theta</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">dunif</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span>
  <span class="va">life_expectancy</span> <span class="op">&lt;-</span> <span class="fu">Rcalculate_life_expectancy</span><span class="op">(</span><span class="va">theta</span><span class="op">)</span>
<span class="op">}</span><span class="op">)</span></code></pre></div>
<p>Comment on the call to function <code>Rcalculate_life_expectancy()</code>.</p>
<p>Rest is unchanged.</p>
<div class="sourceCode" id="cb48"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">my.data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>survived <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/nimble/man/nimble-R-functions.html">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/nimble/man/nimble-R-functions.html">rep</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">19</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/pkg/nimble/man/nimble-R-functions.html">rep</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">57</span><span class="op">-</span><span class="fl">19</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
<span class="va">my.constants</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>released <span class="op">=</span> <span class="fl">57</span><span class="op">)</span>
<span class="va">parameters.to.save</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/nimble/man/nimble-R-functions.html">c</a></span><span class="op">(</span><span class="st">"theta"</span>, <span class="st">"life_expectancy"</span><span class="op">)</span>
<span class="va">initial.values</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>theta <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">0</span>,<span class="fl">1</span><span class="op">)</span><span class="op">)</span>
<span class="va">n.iter</span> <span class="op">&lt;-</span> <span class="fl">5000</span>
<span class="va">n.burnin</span> <span class="op">&lt;-</span> <span class="fl">1000</span>
<span class="va">n.chains</span> <span class="op">&lt;-</span> <span class="fl">3</span>
<span class="va">mcmc.output</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/nimble/man/nimbleMCMC.html">nimbleMCMC</a></span><span class="op">(</span>code <span class="op">=</span> <span class="va">model</span>,
                          data <span class="op">=</span> <span class="va">my.data</span>,
                          constants <span class="op">=</span> <span class="va">my.constants</span>,
                          inits <span class="op">=</span> <span class="va">initial.values</span>,
                          monitors <span class="op">=</span> <span class="va">parameters.to.save</span>,
                          niter <span class="op">=</span> <span class="va">n.iter</span>,
                          nburnin <span class="op">=</span> <span class="va">n.burnin</span>,
                          nchains <span class="op">=</span> <span class="va">n.chains</span><span class="op">)</span>
<span class="co">## |-------------|-------------|-------------|-------------|</span>
<span class="co">## |-------------------------------------------------------|</span>
<span class="co">## |-------------|-------------|-------------|-------------|</span>
<span class="co">## |-------------------------------------------------------|</span>
<span class="co">## |-------------|-------------|-------------|-------------|</span>
<span class="co">## |-------------------------------------------------------|</span></code></pre></div>
<p>Display outputs.</p>
<div class="sourceCode" id="cb49"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/pkg/MCMCvis/man/MCMCsummary.html">MCMCsummary</a></span><span class="op">(</span>object <span class="op">=</span> <span class="va">mcmc.output</span>, round <span class="op">=</span> <span class="fl">2</span><span class="op">)</span>
<span class="co">##                 mean   sd 2.5%  50% 97.5% Rhat n.eff</span>
<span class="co">## life_expectancy 0.94 0.16 0.67 0.92  1.30 1.01  2454</span>
<span class="co">## theta           0.34 0.06 0.22 0.34  0.46 1.00  2534</span></code></pre></div>
<p>Helpful when object format unusual for NIMBLE, like spatial object. Global environment. <strong>“In general if you do need a nimbleRcall like this, there are a couple of considerations. It is common to need to write a wrapper function, i.e. a function you access via nimbleRcall that calls your actual function of interest with arguments and then return value rearranged as needed. For example, if you just need the eigenvectors, a wrapper function could pick those out and return them. The bigger issue is the returnType declaration: nimble type declarations do not include an R list of type declarations as a nimble type. I think you could use a nimbleList data structure for this purpose. You would have to create a nimbleList type and then use that as the declared returnType. But you would still need to write a wrapper, so that you could convert the list returned from base::eigen into a nimbleList object to return from your wrapper.” See also <a href="https://kenkellner.com/blog/models-with-integrals.html" class="uri">https://kenkellner.com/blog/models-with-integrals.html</a>.</strong></p>
</div>
<div id="code-your-own-sampler" class="section level3" number="2.5.5">
<h3>
<span class="header-section-number">2.5.5</span> Code your own sampler<a class="anchor" aria-label="anchor" href="#code-your-own-sampler"><i class="fas fa-link"></i></a>
</h3>
<div class="sourceCode" id="cb50"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">model</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/nimble/man/nimbleCode.html">nimbleCode</a></span><span class="op">(</span><span class="op">{</span>
  <span class="co"># likelihood</span>
  <span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">released</span><span class="op">)</span><span class="op">{</span>
    <span class="va">survived</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">~</span> <span class="fu">dbern</span><span class="op">(</span><span class="va">theta</span><span class="op">)</span>
  <span class="op">}</span>
  <span class="co"># prior</span>
  <span class="va">theta</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">dunif</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span>
  <span class="va">life_expectancy</span> <span class="op">&lt;-</span> <span class="fu">Rcalculate_life_expectancy</span><span class="op">(</span><span class="va">theta</span><span class="op">)</span>
<span class="op">}</span><span class="op">)</span>
<span class="va">my.data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>survived <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/nimble/man/nimble-R-functions.html">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/nimble/man/nimble-R-functions.html">rep</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">19</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/pkg/nimble/man/nimble-R-functions.html">rep</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">57</span><span class="op">-</span><span class="fl">19</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
<span class="va">my.constants</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>released <span class="op">=</span> <span class="fl">57</span><span class="op">)</span>
<span class="va">parameters.to.save</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/nimble/man/nimble-R-functions.html">c</a></span><span class="op">(</span><span class="st">"theta"</span>, <span class="st">"life_expectancy"</span><span class="op">)</span>
<span class="va">initial.values</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>theta <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">0</span>,<span class="fl">1</span><span class="op">)</span><span class="op">)</span>
<span class="va">n.iter</span> <span class="op">&lt;-</span> <span class="fl">5000</span>
<span class="va">n.burnin</span> <span class="op">&lt;-</span> <span class="fl">1000</span>
<span class="va">n.chains</span> <span class="op">&lt;-</span> <span class="fl">3</span>
<span class="va">mcmc.output</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/nimble/man/nimbleMCMC.html">nimbleMCMC</a></span><span class="op">(</span>code <span class="op">=</span> <span class="va">model</span>,
                          data <span class="op">=</span> <span class="va">my.data</span>,
                          constants <span class="op">=</span> <span class="va">my.constants</span>,
                          inits <span class="op">=</span> <span class="va">initial.values</span>,
                          monitors <span class="op">=</span> <span class="va">parameters.to.save</span>,
                          niter <span class="op">=</span> <span class="va">n.iter</span>,
                          nburnin <span class="op">=</span> <span class="va">n.burnin</span>,
                          nchains <span class="op">=</span> <span class="va">n.chains</span><span class="op">)</span>
<span class="co">## |-------------|-------------|-------------|-------------|</span>
<span class="co">## |-------------------------------------------------------|</span>
<span class="co">## |-------------|-------------|-------------|-------------|</span>
<span class="co">## |-------------------------------------------------------|</span>
<span class="co">## |-------------|-------------|-------------|-------------|</span>
<span class="co">## |-------------------------------------------------------|</span>
<span class="fu"><a href="https://rdrr.io/pkg/MCMCvis/man/MCMCsummary.html">MCMCsummary</a></span><span class="op">(</span>object <span class="op">=</span> <span class="va">mcmc.output</span>, round <span class="op">=</span> <span class="fl">2</span><span class="op">)</span>
<span class="co">##                 mean   sd 2.5%  50% 97.5% Rhat n.eff</span>
<span class="co">## life_expectancy 0.94 0.16 0.67 0.92  1.29    1  2870</span>
<span class="co">## theta           0.34 0.06 0.23 0.34  0.46    1  2916</span></code></pre></div>
<p>Your own Metropolis. <strong>Introduce nimbleFunction earlier <a href="https://r-nimble.org/html_manual/cha-user-defined.html#sec:user-functions" class="uri">https://r-nimble.org/html_manual/cha-user-defined.html#sec:user-functions</a></strong></p>
<div class="sourceCode" id="cb51"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">my_metropolis</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/nimble/man/nimbleFunction.html">nimbleFunction</a></span><span class="op">(</span>
  name <span class="op">=</span> <span class="st">'my_metropolis'</span>,
  contains <span class="op">=</span> <span class="va">sampler_BASE</span>,
  setup <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">model</span>, <span class="va">mvSaved</span>, <span class="va">target</span>, <span class="va">control</span><span class="op">)</span> <span class="op">{</span>
    <span class="va">calcNodes</span> <span class="op">&lt;-</span> <span class="va">model</span><span class="op">$</span><span class="fu">getDependencies</span><span class="op">(</span><span class="va">target</span><span class="op">)</span>
    <span class="va">scale</span> <span class="op">&lt;-</span> <span class="va">control</span><span class="op">$</span><span class="va">scale</span>
  <span class="op">}</span>,
  run <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="op">{</span>
    <span class="va">initialLP</span> <span class="op">&lt;-</span> <span class="va">model</span><span class="op">$</span><span class="fu">getLogProb</span><span class="op">(</span><span class="va">calcNodes</span><span class="op">)</span>
    <span class="va">current</span> <span class="op">&lt;-</span> <span class="va">model</span><span class="op">[[</span><span class="va">target</span><span class="op">]</span><span class="op">]</span>
    <span class="va">lcurrent</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="va">current</span> <span class="op">/</span> <span class="op">(</span><span class="fl">1</span> <span class="op">-</span> <span class="va">current</span><span class="op">)</span><span class="op">)</span>
    <span class="va">lproposal</span> <span class="op">&lt;-</span> <span class="va">lcurrent</span>  <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">0</span>, <span class="va">scale</span><span class="op">)</span>
    <span class="va">proposal</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Logistic.html">plogis</a></span><span class="op">(</span><span class="va">lproposal</span><span class="op">)</span>
    <span class="va">model</span><span class="op">[[</span><span class="va">target</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;&lt;-</span> <span class="va">proposal</span>
    <span class="va">proposalLP</span> <span class="op">&lt;-</span> <span class="va">model</span><span class="op">$</span><span class="fu">calculate</span><span class="op">(</span><span class="va">calcNodes</span><span class="op">)</span>
    <span class="va">lMHR</span> <span class="op">&lt;-</span> <span class="va">proposalLP</span> <span class="op">-</span> <span class="va">initialLP</span>
    <span class="kw">if</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">0</span>,<span class="fl">1</span><span class="op">)</span> <span class="op">&lt;</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span><span class="op">(</span><span class="va">lMHR</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
      <span class="co">## accept</span>
      <span class="fu"><a href="https://rdrr.io/pkg/nimble/man/nimCopy.html">copy</a></span><span class="op">(</span>from <span class="op">=</span> <span class="va">model</span>, to <span class="op">=</span> <span class="va">mvSaved</span>, nodes <span class="op">=</span> <span class="va">calcNodes</span>, logProb <span class="op">=</span> <span class="cn">TRUE</span>, row <span class="op">=</span> <span class="fl">1</span><span class="op">)</span>
    <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span>
      <span class="co">## reject</span>
      <span class="fu"><a href="https://rdrr.io/pkg/nimble/man/nimCopy.html">copy</a></span><span class="op">(</span>from <span class="op">=</span> <span class="va">mvSaved</span>, to <span class="op">=</span> <span class="va">model</span>, nodes <span class="op">=</span> <span class="va">calcNodes</span>, logProb <span class="op">=</span> <span class="cn">TRUE</span>, row <span class="op">=</span> <span class="fl">1</span><span class="op">)</span>
    <span class="op">}</span>
  <span class="op">}</span>,
  methods <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>
    reset <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="op">{</span><span class="op">}</span>
  <span class="op">)</span>
<span class="op">)</span></code></pre></div>
<p>Parameter to tune. Seek equivalent in previous chapter.</p>
<div class="sourceCode" id="cb52"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">scale</span> <span class="op">&lt;-</span> <span class="fl">0.05</span></code></pre></div>
<p>Detailed workflow.</p>
<div class="sourceCode" id="cb53"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">Rmodel</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/nimble/man/nimbleModel.html">nimbleModel</a></span><span class="op">(</span><span class="va">model</span>, <span class="va">my.constants</span>, <span class="va">my.data</span>, <span class="fu">initial.values</span><span class="op">(</span><span class="op">)</span><span class="op">)</span>
<span class="va">conf</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/nimble/man/configureMCMC.html">configureMCMC</a></span><span class="op">(</span><span class="va">Rmodel</span>, monitors <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/nimble/man/nimble-R-functions.html">c</a></span><span class="op">(</span><span class="st">'theta'</span><span class="op">)</span><span class="op">)</span>
<span class="co">## ===== Monitors =====</span>
<span class="co">## thin = 1: theta</span>
<span class="co">## ===== Samplers =====</span>
<span class="co">## RW sampler (1)</span>
<span class="co">##   - theta</span>
<span class="va">conf</span><span class="op">$</span><span class="fu">printSamplers</span><span class="op">(</span><span class="op">)</span>
<span class="co">## [1] RW sampler: theta</span>
<span class="va">conf</span><span class="op">$</span><span class="fu">printSamplers</span><span class="op">(</span>byType <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
<span class="co">## RW sampler (1)</span>
<span class="co">##   - theta</span>
<span class="va">conf</span><span class="op">$</span><span class="fu">removeSamplers</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/nimble/man/nimble-R-functions.html">c</a></span><span class="op">(</span><span class="st">'theta'</span><span class="op">)</span><span class="op">)</span>
<span class="va">conf</span><span class="op">$</span><span class="fu">addSampler</span><span class="op">(</span>target <span class="op">=</span> <span class="st">'theta'</span>, type <span class="op">=</span> <span class="st">'my_metropolis'</span>, control <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>scale <span class="op">=</span> <span class="va">scale</span><span class="op">)</span><span class="op">)</span>
<span class="va">conf</span><span class="op">$</span><span class="fu">printSamplers</span><span class="op">(</span><span class="op">)</span>
<span class="co">## [1] my_metropolis sampler: theta,  scale: 0.050000000000000003</span>
<span class="va">conf</span><span class="op">$</span><span class="fu">printMonitors</span><span class="op">(</span><span class="op">)</span>
<span class="co">## thin = 1: theta</span>
<span class="va">Rmcmc</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/nimble/man/buildMCMC.html">buildMCMC</a></span><span class="op">(</span><span class="va">conf</span><span class="op">)</span>
<span class="va">out</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/nimble/man/compileNimble.html">compileNimble</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>model <span class="op">=</span> <span class="va">Rmodel</span>, mcmc <span class="op">=</span> <span class="va">Rmcmc</span><span class="op">)</span><span class="op">)</span>
<span class="va">Cmcmc</span> <span class="op">&lt;-</span> <span class="va">out</span><span class="op">$</span><span class="va">mcmc</span>
<span class="va">samples</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/nimble/man/runMCMC.html">runMCMC</a></span><span class="op">(</span><span class="va">Cmcmc</span>, niter <span class="op">=</span> <span class="fl">5000</span>, nburnin <span class="op">=</span> <span class="fl">1000</span><span class="op">)</span>
<span class="co">## |-------------|-------------|-------------|-------------|</span>
<span class="co">## |-------------------------------------------------------|</span>
<span class="fu"><a href="https://rdrr.io/pkg/nimble/man/nimble-internal.html">samplesSummary</a></span><span class="op">(</span><span class="va">samples</span><span class="op">)</span>
<span class="co">##         Mean Median St.Dev. 95%CI_low 95%CI_upp</span>
<span class="co">## theta 0.3309 0.3306 0.05987    0.2149    0.4549</span>
<span class="fu">chainsPlot</span><span class="op">(</span><span class="va">samples</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="banana-book_files/figure-html/unnamed-chunk-67-1.png" width="672"></div>
<p>Change parameter to tune.</p>
<div class="sourceCode" id="cb54"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">scale</span> <span class="op">&lt;-</span> <span class="fl">2</span>
<span class="va">Rmodel</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/nimble/man/nimbleModel.html">nimbleModel</a></span><span class="op">(</span><span class="va">model</span>, <span class="va">my.constants</span>, <span class="va">my.data</span>, <span class="fu">initial.values</span><span class="op">(</span><span class="op">)</span><span class="op">)</span>
<span class="va">conf</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/nimble/man/configureMCMC.html">configureMCMC</a></span><span class="op">(</span><span class="va">Rmodel</span>, monitors <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/nimble/man/nimble-R-functions.html">c</a></span><span class="op">(</span><span class="st">'theta'</span><span class="op">)</span><span class="op">)</span>
<span class="co">## ===== Monitors =====</span>
<span class="co">## thin = 1: theta</span>
<span class="co">## ===== Samplers =====</span>
<span class="co">## RW sampler (1)</span>
<span class="co">##   - theta</span>
<span class="va">conf</span><span class="op">$</span><span class="fu">printSamplers</span><span class="op">(</span><span class="op">)</span>
<span class="co">## [1] RW sampler: theta</span>
<span class="va">conf</span><span class="op">$</span><span class="fu">printSamplers</span><span class="op">(</span>byType <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
<span class="co">## RW sampler (1)</span>
<span class="co">##   - theta</span>
<span class="va">conf</span><span class="op">$</span><span class="fu">removeSamplers</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/nimble/man/nimble-R-functions.html">c</a></span><span class="op">(</span><span class="st">'theta'</span><span class="op">)</span><span class="op">)</span>
<span class="va">conf</span><span class="op">$</span><span class="fu">addSampler</span><span class="op">(</span>target <span class="op">=</span> <span class="st">'theta'</span>, type <span class="op">=</span> <span class="st">'my_metropolis'</span>, control <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>scale <span class="op">=</span> <span class="va">scale</span><span class="op">)</span><span class="op">)</span>
<span class="va">conf</span><span class="op">$</span><span class="fu">printSamplers</span><span class="op">(</span><span class="op">)</span>
<span class="co">## [1] my_metropolis sampler: theta,  scale: 2</span>
<span class="va">conf</span><span class="op">$</span><span class="fu">printMonitors</span><span class="op">(</span><span class="op">)</span>
<span class="co">## thin = 1: theta</span>
<span class="va">Rmcmc</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/nimble/man/buildMCMC.html">buildMCMC</a></span><span class="op">(</span><span class="va">conf</span><span class="op">)</span>
<span class="va">out</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/nimble/man/compileNimble.html">compileNimble</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>model <span class="op">=</span> <span class="va">Rmodel</span>, mcmc <span class="op">=</span> <span class="va">Rmcmc</span><span class="op">)</span><span class="op">)</span>
<span class="va">Cmcmc</span> <span class="op">&lt;-</span> <span class="va">out</span><span class="op">$</span><span class="va">mcmc</span>
<span class="va">samples</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/nimble/man/runMCMC.html">runMCMC</a></span><span class="op">(</span><span class="va">Cmcmc</span>, niter <span class="op">=</span> <span class="fl">5000</span>, nburnin <span class="op">=</span> <span class="fl">1000</span><span class="op">)</span>
<span class="co">## |-------------|-------------|-------------|-------------|</span>
<span class="co">## |-------------------------------------------------------|</span>
<span class="fu"><a href="https://rdrr.io/pkg/nimble/man/nimble-internal.html">samplesSummary</a></span><span class="op">(</span><span class="va">samples</span><span class="op">)</span>
<span class="co">##         Mean Median St.Dev. 95%CI_low 95%CI_upp</span>
<span class="co">## theta 0.3287 0.3248 0.05794    0.2282    0.4475</span>
<span class="fu">chainsPlot</span><span class="op">(</span><span class="va">samples</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="banana-book_files/figure-html/unnamed-chunk-68-1.png" width="672"></div>
<p>Draw parallel with previous chapter.</p>
</div>
<div id="write-your-own-distribution" class="section level3" number="2.5.6">
<h3>
<span class="header-section-number">2.5.6</span> Write your own distribution<a class="anchor" aria-label="anchor" href="#write-your-own-distribution"><i class="fas fa-link"></i></a>
</h3>
<p>Example from <a href="https://r-nimble.org/html_manual/cha-user-defined.html#sec:user-distributions" class="uri">https://r-nimble.org/html_manual/cha-user-defined.html#sec:user-distributions</a>. Recode the beta distribution? Have a look to the raw NIMBLE code.</p>
</div>
</div>
<div id="when-things-go-wrong-tip-and-tricks" class="section level2" number="2.6">
<h2>
<span class="header-section-number">2.6</span> When things go wrong: Tip and tricks<a class="anchor" aria-label="anchor" href="#when-things-go-wrong-tip-and-tricks"><i class="fas fa-link"></i></a>
</h2>
<p>Main problems. Call to community.</p>
</div>
<div id="summary-1" class="section level2" number="2.7">
<h2>
<span class="header-section-number">2.7</span> Summary<a class="anchor" aria-label="anchor" href="#summary-1"><i class="fas fa-link"></i></a>
</h2>
<ul>
<li><p>Blabla.</p></li>
<li><p>Reblabla.</p></li>
</ul>
</div>
<div id="suggested-reading-1" class="section level2" number="2.8">
<h2>
<span class="header-section-number">2.8</span> Suggested reading<a class="anchor" aria-label="anchor" href="#suggested-reading-1"><i class="fas fa-link"></i></a>
</h2>
<ul>
<li><p>Official website <a href="https://r-nimble.org">https://r-nimble.org</a></p></li>
<li><p>User Manual <a href="https://r-nimble.org/html_manual/cha-welcome-nimble.html">https://r-nimble.org/html_manual/cha-welcome-nimble.html</a> and <a href="https://r-nimble.org/cheatsheets/NimbleCheatSheet.pdf">cheatsheet</a>.</p></li>
<li><p>Users mailing list <a href="https://groups.google.com/forum/#!forum/nimble-users">https://groups.google.com/forum/#!forum/nimble-users</a></p></li>
<li><p>Training material <a href="https://github.com/nimble-training">https://github.com/nimble-training</a></p></li>
<li><p>Reference to cite when using nimble in a publication:</p></li>
</ul>
<blockquote>
<p>de Valpine, P., D. Turek, C. J. Paciorek, C. Anderson-Bergman, D. Temple Lang, and R. Bodik (2017). <a href="https://arxiv.org/pdf/1505.05093.pdf">Programming With Models: Writing Statistical Algorithms for General Model Structures With NIMBLE</a>. <em>Journal of Computational and Graphical Statistics</em> <strong>26</strong> (2): 403–13.</p>
</blockquote>
<!-- ## A dire quelque part? -->
<!-- Pourquoi Nimble plutôt que Stan? Syntaxe BUGS, also discrete latent states easier to deal with, no need to marginalise. In Stan you marginalise (ref forward to relevant section of the book), but difficult endeavour, and you do not need to do that with NIMBLE, it has algorithms that work fine with discrete latent states.  -->

</div>
</div>
  <div class="chapter-nav">
<div class="prev"><a href="crashcourse.html"><span class="header-section-number">1</span> Bayesian statistics &amp; MCMC</a></div>
<div class="next"><a href="hmmcapturerecapture.html"><span class="header-section-number">3</span> Hidden Markov models</a></div>
</div></main><div class="col-md-3 col-lg-2 d-none d-md-block sidebar sidebar-chapter">
    <nav id="toc" data-toggle="toc" aria-label="On this page"><h2>On this page</h2>
      <ul class="nav navbar-nav">
<li><a class="nav-link" href="#intronimble"><span class="header-section-number">2</span> NIMBLE tutorial</a></li>
<li><a class="nav-link" href="#introduction-2"><span class="header-section-number">2.1</span> Introduction</a></li>
<li><a class="nav-link" href="#what-is-nimble"><span class="header-section-number">2.2</span> What is NIMBLE?</a></li>
<li>
<a class="nav-link" href="#running-nimble"><span class="header-section-number">2.3</span> Running NIMBLE</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#the-basics"><span class="header-section-number">2.3.1</span> The basics</a></li>
<li><a class="nav-link" href="#into-specifics"><span class="header-section-number">2.3.2</span> Into specifics</a></li>
</ul>
</li>
<li>
<a class="nav-link" href="#making-sense-of-the-mcmc-outputs"><span class="header-section-number">2.4</span> Making sense of the MCMC outputs</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#post-process-mcmc-outputs-by-hand"><span class="header-section-number">2.4.1</span> Post-process MCMC outputs by hand</a></li>
<li><a class="nav-link" href="#post-process-mcmc-outputs-without-pain"><span class="header-section-number">2.4.2</span> Post-process MCMC outputs without pain</a></li>
</ul>
</li>
<li>
<a class="nav-link" href="#advanced-stuff"><span class="header-section-number">2.5</span> Advanced stuff</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#vectorization"><span class="header-section-number">2.5.1</span> Vectorization</a></li>
<li><a class="nav-link" href="#flexible-specification-of-distributions"><span class="header-section-number">2.5.2</span> Flexible specification of distributions</a></li>
<li><a class="nav-link" href="#behind-the-hood"><span class="header-section-number">2.5.3</span> Behind the hood</a></li>
<li><a class="nav-link" href="#call-r-functions-within-nimble"><span class="header-section-number">2.5.4</span> Call R functions within NIMBLE</a></li>
<li><a class="nav-link" href="#code-your-own-sampler"><span class="header-section-number">2.5.5</span> Code your own sampler</a></li>
<li><a class="nav-link" href="#write-your-own-distribution"><span class="header-section-number">2.5.6</span> Write your own distribution</a></li>
</ul>
</li>
<li><a class="nav-link" href="#when-things-go-wrong-tip-and-tricks"><span class="header-section-number">2.6</span> When things go wrong: Tip and tricks</a></li>
<li><a class="nav-link" href="#summary-1"><span class="header-section-number">2.7</span> Summary</a></li>
<li><a class="nav-link" href="#suggested-reading-1"><span class="header-section-number">2.8</span> Suggested reading</a></li>
</ul>

      <div class="book-extra">
        <ul class="list-unstyled">
<li><a id="book-source" href="https://github.com/oliviergimenez/banana-book/blob/master/nimble.Rmd">View source <i class="fab fa-github"></i></a></li>
          <li><a id="book-edit" href="https://github.com/oliviergimenez/banana-book/edit/master/nimble.Rmd">Edit this page <i class="fab fa-github"></i></a></li>
        </ul>
</div>
    </nav>
</div>

</div>
</div> <!-- .container -->

<footer class="bg-primary text-light mt-5"><div class="container"><div class="row">

  <div class="col-12 col-md-6 mt-3">
    <p>"<strong>Bayesian Analysis of Capture-Recapture Data with Hidden Markov Models</strong>: Theory and Case Studies in R" was written by Olivier Gimenez. It was last built on 2022-01-24.</p>
  </div>

  <div class="col-12 col-md-6 mt-3">
    <p>This book was built by the <a class="text-light" href="https://bookdown.org">bookdown</a> R package.</p>
  </div>

</div></div>
</footer><!-- dynamically load mathjax for compatibility with self-contained --><script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script><script type="text/x-mathjax-config">const popovers = document.querySelectorAll('a.footnote-ref[data-toggle="popover"]');
for (let popover of popovers) {
  const div = document.createElement('div');
  div.setAttribute('style', 'position: absolute; top: 0, left:0; width:0, height:0, overflow: hidden; visibility: hidden;');
  div.innerHTML = popover.getAttribute('data-content');

  var has_math = div.querySelector("span.math");
  if (has_math) {
    document.body.appendChild(div);
    MathJax.Hub.Queue(["Typeset", MathJax.Hub, div]);
    MathJax.Hub.Queue(function() {
      popover.setAttribute('data-content', div.innerHTML);
      document.body.removeChild(div);
    })
  }
}
</script>
</body>
</html>
