<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Chapter 2 NIMBLE | Bayesian Analysis of Capture-Recapture Data with Hidden Markov Models</title>
<meta name="author" content="Olivier Gimenez">
<meta name="description" content="coder Metropolis d’au-dessus dans Nimble basculer des trucs de speed up ici on peut utilise MCMCvis, et ce que fait l’équipe Nimble pourquoi Nimble plutôt que Jags? Dev team friendly, active dev,...">
<meta name="generator" content="bookdown 0.23 with bs4_book()">
<meta property="og:title" content="Chapter 2 NIMBLE | Bayesian Analysis of Capture-Recapture Data with Hidden Markov Models">
<meta property="og:type" content="book">
<meta property="og:url" content="https://oliviergimenez.github.io/bayesian-cr-workshop/intronimble.html">
<meta property="og:description" content="coder Metropolis d’au-dessus dans Nimble basculer des trucs de speed up ici on peut utilise MCMCvis, et ce que fait l’équipe Nimble pourquoi Nimble plutôt que Jags? Dev team friendly, active dev,...">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Chapter 2 NIMBLE | Bayesian Analysis of Capture-Recapture Data with Hidden Markov Models">
<meta name="twitter:description" content="coder Metropolis d’au-dessus dans Nimble basculer des trucs de speed up ici on peut utilise MCMCvis, et ce que fait l’équipe Nimble pourquoi Nimble plutôt que Jags? Dev team friendly, active dev,...">
<!-- JS --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://kit.fontawesome.com/6ecbd6c532.js" crossorigin="anonymous"></script><script src="libs/header-attrs-2.11/header-attrs.js"></script><script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="libs/bootstrap-4.6.0/bootstrap.min.css" rel="stylesheet">
<script src="libs/bootstrap-4.6.0/bootstrap.bundle.min.js"></script><script src="libs/bs3compat-0.3.1/transition.js"></script><script src="libs/bs3compat-0.3.1/tabs.js"></script><script src="libs/bs3compat-0.3.1/bs3compat.js"></script><link href="libs/bs4_book-1.0.0/bs4_book.css" rel="stylesheet">
<script src="libs/bs4_book-1.0.0/bs4_book.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- CSS --><link rel="stylesheet" href="bs4_style.css">
</head>
<body data-spy="scroll" data-target="#toc">

<div class="container-fluid">
<div class="row">
  <header class="col-sm-12 col-lg-3 sidebar sidebar-book"><a class="sr-only sr-only-focusable" href="#content">Skip to main content</a>

    <div class="d-flex align-items-start justify-content-between">
      <h1>
        <a href="index.html" title="Theory and Case Studies in R">Bayesian Analysis of Capture-Recapture Data with Hidden Markov Models</a>:
        <small class="text-muted">Theory and Case Studies in R</small>
      </h1>
      <button class="btn btn-outline-primary d-lg-none ml-2 mt-1" type="button" data-toggle="collapse" data-target="#main-nav" aria-expanded="true" aria-controls="main-nav"><i class="fas fa-bars"></i><span class="sr-only">Show table of contents</span></button>
    </div>

    <div id="main-nav" class="collapse-lg">
      <form role="search">
        <input id="search" class="form-control" type="search" placeholder="Search" aria-label="Search">
</form>

      <nav aria-label="Table of contents"><h2>Table of contents</h2>
        <ul class="book-toc list-unstyled">
<li><a class="" href="index.html">Welcome</a></li>
<li><a class="" href="preface.html">Preface</a></li>
<li><a class="" href="about-the-author.html">About the author</a></li>
<li class="book-part">I. Fundations</li>
<li><a class="" href="introduction.html">Introduction</a></li>
<li><a class="" href="crashcourse.html"><span class="header-section-number">1</span> Bayesian statistics &amp; MCMC</a></li>
<li><a class="active" href="intronimble.html"><span class="header-section-number">2</span> NIMBLE</a></li>
<li><a class="" href="hmmcapturerecapture.html"><span class="header-section-number">3</span> Hidden Markov models</a></li>
<li class="book-part">II. Transitions</li>
<li><a class="" href="introduction-3.html">Introduction</a></li>
<li><a class="" href="survival.html"><span class="header-section-number">4</span> Survival</a></li>
<li><a class="" href="covariates.html"><span class="header-section-number">5</span> Covariates</a></li>
<li><a class="" href="dispersal.html"><span class="header-section-number">6</span> Dispersal</a></li>
<li><a class="" href="model-selection.html"><span class="header-section-number">7</span> Model selection and validation</a></li>
<li class="book-part">III. States</li>
<li><a class="" href="introduction-4.html">Introduction</a></li>
<li><a class="" href="uncertainty.html"><span class="header-section-number">8</span> State uncertainty</a></li>
<li><a class="" href="hsmm.html"><span class="header-section-number">9</span> Hidden semi-Markov models</a></li>
<li class="book-part">IV. Case studies</li>
<li><a class="" href="introduction-5.html">Introduction</a></li>
<li><a class="" href="tradeoffs.html"><span class="header-section-number">10</span> Life history theory</a></li>
<li><a class="" href="abundance.html"><span class="header-section-number">11</span> Abundance</a></li>
<li><a class="" href="stopover.html"><span class="header-section-number">12</span> Stopover duration</a></li>
<li><a class="" href="individual-dependence.html"><span class="header-section-number">13</span> Individual dependence</a></li>
<li class="book-part">V. Conclusion</li>
<li><a class="" href="take-home-messages.html">Take-home messages</a></li>
<li><a class="" href="faq.html">FAQ</a></li>
<li><a class="" href="references.html">References</a></li>
</ul>

        <div class="book-extra">
          <p><a id="book-repo" href="https://github.com/oliviergimenez/banana-book">View book source <i class="fab fa-github"></i></a></p>
        </div>
      </nav>
</div>
  </header><main class="col-sm-12 col-md-9 col-lg-7" id="content"><div id="intronimble" class="section level1" number="2">
<h1>
<span class="header-section-number">2</span> NIMBLE<a class="anchor" aria-label="anchor" href="#intronimble"><i class="fas fa-link"></i></a>
</h1>
<p><strong>coder Metropolis d’au-dessus dans Nimble</strong>
<strong>basculer des trucs de speed up ici</strong>
<strong>on peut utilise MCMCvis, et ce que fait l’équipe Nimble</strong>
<strong>pourquoi Nimble plutôt que Jags? Dev team friendly, active dev, also much more flexible, and much more than just MCMC sampler. Pourquoi Nimble plutôt que Stan; syntaxe BUGS, also discrete latent states easier to deal with, no need to marginalise</strong></p>
<div id="introduction-2" class="section level2" number="2.1">
<h2>
<span class="header-section-number">2.1</span> Introduction<a class="anchor" aria-label="anchor" href="#introduction-2"><i class="fas fa-link"></i></a>
</h2>
<p>In this second chapter, you will learn what the Bayesian theory is, and how you may use it with a simple example. You will also see how to implement simulation algorithms to implement the Bayesian method for more complex analyses. This is not an exhaustive treatment of Bayesian statistics, but you should get what you need to navigate through the rest of the book.</p>
</div>
<div id="what-is-nimble" class="section level2" number="2.2">
<h2>
<span class="header-section-number">2.2</span> What is NIMBLE?<a class="anchor" aria-label="anchor" href="#what-is-nimble"><i class="fas fa-link"></i></a>
</h2>
<div class="figure">
<span style="display:block;" id="fig:pressure-1"></span>
<img src="images/ToddStudents_Meme.jpg" alt="(Meme created by Todd Arnold's wonderful students)" width="24%"><p class="caption">
Figure 2.1: (Meme created by Todd Arnold’s wonderful students)
</p>
</div>
<div class="figure">
<span style="display:block;" id="fig:pressure-2"></span>
<img src="images/RobRob_Comment_edited.png" alt="(Meme created by Todd Arnold's wonderful students)" width="60%"><p class="caption">
Figure 2.2: (Meme created by Todd Arnold’s wonderful students)
</p>
</div>
<ul>
<li><p><strong>N</strong>umerical <strong>I</strong>nference for statistical <strong>M</strong>odels using <strong>B</strong>ayesian and <strong>L</strong>ikelihood <strong>E</strong>stimation.</p></li>
<li><p>A framework for hierarchical statistical models and algorithms.</p></li>
<li><p>Uses almost the same model code as WinBUGS, OpenBUGS, and JAGS.</p></li>
<li><p>An extension of the BUGS language: additional syntax, custom functions and distributions.</p></li>
<li><p>A configurable system for MCMC.</p></li>
<li><p>A library of other methods (SMC, MCEM).</p></li>
<li><p>Sequential Monte Carlo (particle filtering)</p></li>
<li><p>Monte Carlo Expectation Maximization (maximum likelihood)</p></li>
<li><p>A model-generic programming system to write new analysis methods.</p></li>
<li><p>because it extends the BUGS language for writing new functions and distributions,</p></li>
<li><p>and provides samplers that can deal with discrete latent states</p></li>
</ul>
<p>The proposed semiparametric LVM and Bayesian inference were implemented via nimble. nimble is an R package for programming with BUGS models, which allows for fitting models specified using syntax similar to WinBUGS and JAGS, but with more flexibility in defining the models and algorithms. Users can operate from within R, and nimble will generate the C++ code for faster computation. In this section, we introduce how to carry out the proposed analysis using nimble 0.6–10 in R 3.4.1.</p>

<div class="rmdnote">
The <em>hypothesis</em> is a working assumption about which you want to learn using <em>data</em>. In capture–recapture analyses, the hypothesis might be a parameter like detection probability, or regression parameters in a relationship between survival probability and a covariate. Bayes’ theorem tells us how to obtain the probability of a hypothesis given the data we have.
</div>
</div>
<div id="load-nimble-package" class="section level2" number="2.3">
<h2>
<span class="header-section-number">2.3</span> Load <code>nimble</code> package<a class="anchor" aria-label="anchor" href="#load-nimble-package"><i class="fas fa-link"></i></a>
</h2>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://r-nimble.org">nimble</a></span><span class="op">)</span></code></pre></div>
</div>
<div id="build-model-made-of-likelihood-and-priors" class="section level2" number="2.4">
<h2>
<span class="header-section-number">2.4</span> Build model, made of likelihood and priors<a class="anchor" aria-label="anchor" href="#build-model-made-of-likelihood-and-priors"><i class="fas fa-link"></i></a>
</h2>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">naive.survival.model</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/nimble/man/nimbleCode.html">nimbleCode</a></span><span class="op">(</span><span class="op">{</span>
  <span class="co"># prior</span>
  <span class="va">phi</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">dunif</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span>
  <span class="co"># likelihood</span>
  <span class="va">y</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/stats/Binomial.html">dbinom</a></span><span class="op">(</span><span class="va">phi</span>, <span class="va">n</span><span class="op">)</span>
<span class="op">}</span><span class="op">)</span></code></pre></div>
</div>
<div id="syntax-whats-newbetterdifferent" class="section level2" number="2.5">
<h2>
<span class="header-section-number">2.5</span> Syntax: what’s new/better/different?<a class="anchor" aria-label="anchor" href="#syntax-whats-newbetterdifferent"><i class="fas fa-link"></i></a>
</h2>
<ul>
<li>Vectorization</li>
</ul>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># JAGS (&amp; Nimble)</span>
<span class="kw">for</span><span class="op">(</span><span class="va">t</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">Tmax</span><span class="op">)</span><span class="op">{</span>
  <span class="va">x</span><span class="op">[</span><span class="va">t</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">Mu.x</span> <span class="op">+</span> <span class="va">epsilon</span><span class="op">[</span><span class="va">t</span><span class="op">]</span>
<span class="op">}</span>

<span class="co"># Nimble</span>
<span class="va">x</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="va">Tmax</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">Mu.x</span> <span class="op">+</span> <span class="va">epsilon</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="va">Tmax</span><span class="op">]</span></code></pre></div>
<ul>
<li>More flexible specification of distributions</li>
</ul>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># JAGS (&amp; Nimble)</span>
<span class="kw">for</span><span class="op">(</span><span class="va">t</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">Tmax</span><span class="op">)</span><span class="op">{</span>
  <span class="va">epsilon</span><span class="op">[</span><span class="va">t</span><span class="op">]</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">dnorm</a></span><span class="op">(</span><span class="fl">0</span>, <span class="va">tau</span><span class="op">)</span>
<span class="op">}</span>
<span class="va">tau</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/nimble/man/nimble-math.html">pow</a></span><span class="op">(</span><span class="va">sigma</span>, <span class="op">-</span><span class="fl">2</span><span class="op">)</span>
<span class="va">sigma</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">dunif</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">5</span><span class="op">)</span>

<span class="co"># Nimble</span>
<span class="kw">for</span><span class="op">(</span><span class="va">t</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">Tmax</span><span class="op">)</span><span class="op">{</span>
  <span class="va">epsilon</span><span class="op">[</span><span class="va">t</span><span class="op">]</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">dnorm</a></span><span class="op">(</span><span class="fl">0</span>, sd <span class="op">=</span> <span class="va">sigma</span><span class="op">)</span>
<span class="op">}</span>
<span class="va">sigma</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">dunif</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">5</span><span class="op">)</span></code></pre></div>
<ul>
<li>Your own functions and distributions</li>
</ul>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">x</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="va">Tmax</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu">myNimbleFunction</span><span class="op">(</span>a <span class="op">=</span> <span class="va">Mu.x</span>, b <span class="op">=</span> <span class="va">epsilon</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="va">Tmax</span><span class="op">]</span><span class="op">)</span></code></pre></div>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">sigma</span> <span class="op">~</span> <span class="fu">dCustomDistr</span><span class="op">(</span>c <span class="op">=</span> <span class="fl">0.5</span>, z <span class="op">=</span> <span class="fl">10</span><span class="op">)</span></code></pre></div>
<ul>
<li>The end of empty indices</li>
</ul>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># JAGS</span>
<span class="va">sum.x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">x</span><span class="op">[</span><span class="op">]</span><span class="op">)</span>

<span class="co"># Nimble</span>
<span class="va">sum.x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">x</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="va">Tmax</span><span class="op">]</span><span class="op">)</span></code></pre></div>
<ul>
<li>&amp; more…</li>
</ul>
</div>
<div id="read-in-data" class="section level2" number="2.6">
<h2>
<span class="header-section-number">2.6</span> Read in data<a class="anchor" aria-label="anchor" href="#read-in-data"><i class="fas fa-link"></i></a>
</h2>
<p>Back to our naive survival model:</p>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">naive.survival.model</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/nimble/man/nimbleCode.html">nimbleCode</a></span><span class="op">(</span><span class="op">{</span>
  <span class="co"># prior</span>
  <span class="va">phi</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">dunif</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span>
  <span class="co"># likelihood</span>
  <span class="va">y</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/stats/Binomial.html">dbinom</a></span><span class="op">(</span><span class="va">phi</span>, <span class="va">n</span><span class="op">)</span>
<span class="op">}</span><span class="op">)</span></code></pre></div>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">my.data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fl">57</span>, y <span class="op">=</span> <span class="fl">19</span><span class="op">)</span></code></pre></div>
</div>
<div id="distinguish-constants-and-data" class="section level2" number="2.7">
<h2>
<span class="header-section-number">2.7</span> Distinguish constants and data<a class="anchor" aria-label="anchor" href="#distinguish-constants-and-data"><i class="fas fa-link"></i></a>
</h2>
<p>To Nimble, not all “data” is data…</p>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">my.constants</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fl">57</span><span class="op">)</span>
<span class="va">my.data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>y <span class="op">=</span> <span class="fl">19</span><span class="op">)</span></code></pre></div>
<p><strong>Constants</strong>:
+ Can never be changed
+ Must be provided when a model is defined (part of the model structure)
+ E.g. vector of known index values, variables used to define for-loops, etc.</p>
<p>After defining the model code, we should define the constants, initial values and data list. Compared to WinBUGS and JAGS, data and initial values can be defined in the same way, while ‘constants’ is a new list that contains the values that would not change, including the variables that define for-loop indices. In our settings, the lists of data, constants and initial values are given as follows:</p>
<p>To Nimble, not all “data” is data…</p>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">my.constants</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fl">57</span><span class="op">)</span>
<span class="va">my.data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>y <span class="op">=</span> <span class="fl">19</span><span class="op">)</span></code></pre></div>
<p><strong>Data</strong>:
+ Can be changed without re-building the model
+ Can be (re-)simulated within a model
+ E.g. stuff that <em>only</em> appears to the left of a “~”</p>
<p>For computational efficiency, better to specify as much as possible as constants.</p>
<p>Nimble will help you with this!</p>
</div>
<div id="specify-initial-values" class="section level2" number="2.8">
<h2>
<span class="header-section-number">2.8</span> Specify initial values<a class="anchor" aria-label="anchor" href="#specify-initial-values"><i class="fas fa-link"></i></a>
</h2>
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">initial.values</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>phi <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">0</span>,<span class="fl">1</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">initial.values</span><span class="op">(</span><span class="op">)</span>
<span class="co">## $phi</span>
<span class="co">## [1] 0.2046</span></code></pre></div>
</div>
<div id="which-parameters-to-save" class="section level2" number="2.9">
<h2>
<span class="header-section-number">2.9</span> Which parameters to save?<a class="anchor" aria-label="anchor" href="#which-parameters-to-save"><i class="fas fa-link"></i></a>
</h2>
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">parameters.to.save</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/nimble/man/nimble-R-functions.html">c</a></span><span class="op">(</span><span class="st">"phi"</span><span class="op">)</span></code></pre></div>
</div>
<div id="mcmc-details" class="section level2" number="2.10">
<h2>
<span class="header-section-number">2.10</span> MCMC details<a class="anchor" aria-label="anchor" href="#mcmc-details"><i class="fas fa-link"></i></a>
</h2>
<div class="sourceCode" id="cb31"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">n.iter</span> <span class="op">&lt;-</span> <span class="fl">5000</span>
<span class="va">n.burnin</span> <span class="op">&lt;-</span> <span class="fl">1000</span>
<span class="va">n.chains</span> <span class="op">&lt;-</span> <span class="fl">2</span>
<span class="va">n.thin</span> <span class="op">&lt;-</span> <span class="fl">1</span></code></pre></div>
<p>Number of posterior samples per chain:</p>
<p><span class="math display">\[n.posterior = \frac{n.iter - n.burnin}{n.thin}\]</span></p>
</div>
<div id="run-model-tadaa" class="section level2" number="2.11">
<h2>
<span class="header-section-number">2.11</span> Run model, tadaa!<a class="anchor" aria-label="anchor" href="#run-model-tadaa"><i class="fas fa-link"></i></a>
</h2>
<div class="sourceCode" id="cb32"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">mcmc.output</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/nimble/man/nimbleMCMC.html">nimbleMCMC</a></span><span class="op">(</span>code <span class="op">=</span> <span class="va">naive.survival.model</span>,
                          data <span class="op">=</span> <span class="va">my.data</span>,
                          constants <span class="op">=</span> <span class="va">my.constants</span>,
                          inits <span class="op">=</span> <span class="va">initial.values</span>,
                          monitors <span class="op">=</span> <span class="va">parameters.to.save</span>,
                          thin <span class="op">=</span> <span class="va">n.thin</span>,
                          niter <span class="op">=</span> <span class="va">n.iter</span>,
                          nburnin <span class="op">=</span> <span class="va">n.burnin</span>,
                          nchains <span class="op">=</span> <span class="va">n.chains</span><span class="op">)</span></code></pre></div>
</div>
<div id="explore-mcmc-outputs" class="section level2" number="2.12">
<h2>
<span class="header-section-number">2.12</span> Explore MCMC outputs<a class="anchor" aria-label="anchor" href="#explore-mcmc-outputs"><i class="fas fa-link"></i></a>
</h2>
<div class="sourceCode" id="cb33"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/utils/str.html">str</a></span><span class="op">(</span><span class="va">mcmc.output</span><span class="op">)</span>
<span class="co">## List of 2</span>
<span class="co">##  $ chain1: num [1:4000, 1] 0.36 0.432 0.374 0.374 0.412 ...</span>
<span class="co">##   ..- attr(*, "dimnames")=List of 2</span>
<span class="co">##   .. ..$ : NULL</span>
<span class="co">##   .. ..$ : chr "phi"</span>
<span class="co">##  $ chain2: num [1:4000, 1] 0.325 0.325 0.384 0.384 0.475 ...</span>
<span class="co">##   ..- attr(*, "dimnames")=List of 2</span>
<span class="co">##   .. ..$ : NULL</span>
<span class="co">##   .. ..$ : chr "phi"</span></code></pre></div>
<div class="sourceCode" id="cb34"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">mcmc.output</span><span class="op">$</span><span class="va">chain1</span><span class="op">)</span>
<span class="co">##         phi</span>
<span class="co">## [1,] 0.3604</span>
<span class="co">## [2,] 0.4323</span>
<span class="co">## [3,] 0.3739</span>
<span class="co">## [4,] 0.3739</span>
<span class="co">## [5,] 0.4125</span>
<span class="co">## [6,] 0.4125</span></code></pre></div>
<div class="inline-figure"><img src="banana-book_files/figure-html/unnamed-chunk-49-1.png" width="672"></div>
</div>
<div id="numerical-summaries" class="section level2" number="2.13">
<h2>
<span class="header-section-number">2.13</span> Numerical summaries<a class="anchor" aria-label="anchor" href="#numerical-summaries"><i class="fas fa-link"></i></a>
</h2>
<div class="sourceCode" id="cb35"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/caseyyoungflesh/MCMCvis">MCMCvis</a></span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/pkg/MCMCvis/man/MCMCsummary.html">MCMCsummary</a></span><span class="op">(</span><span class="va">mcmc.output</span>, round <span class="op">=</span> <span class="fl">2</span><span class="op">)</span>
<span class="co">##     mean   sd 2.5%  50% 97.5% Rhat n.eff</span>
<span class="co">## phi 0.34 0.06 0.23 0.34  0.46    1  1926</span></code></pre></div>
</div>
<div id="trace-and-posterior-density" class="section level2" number="2.14">
<h2>
<span class="header-section-number">2.14</span> Trace and posterior density<a class="anchor" aria-label="anchor" href="#trace-and-posterior-density"><i class="fas fa-link"></i></a>
</h2>
<div class="sourceCode" id="cb36"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/pkg/MCMCvis/man/MCMCtrace.html">MCMCtrace</a></span><span class="op">(</span><span class="va">mcmc.output</span>,
          pdf <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></code></pre></div>
<div class="sourceCode" id="cb37"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/pkg/MCMCvis/man/MCMCtrace.html">MCMCtrace</a></span><span class="op">(</span><span class="va">mcmc.output</span>,
          pdf <span class="op">=</span> <span class="cn">FALSE</span>,
          ind <span class="op">=</span> <span class="cn">TRUE</span>,
          Rhat <span class="op">=</span> <span class="cn">TRUE</span>,
          n.eff <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></code></pre></div>
</div>
<div id="our-nimble-workflow-so-far" class="section level2" number="2.15">
<h2>
<span class="header-section-number">2.15</span> Our <code>nimble</code> workflow so far<a class="anchor" aria-label="anchor" href="#our-nimble-workflow-so-far"><i class="fas fa-link"></i></a>
</h2>
<div class="sourceCode" id="cb38"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">knitr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/knitr/man/include_graphics.html">include_graphics</a></span><span class="op">(</span><span class="st">"images/nimble_workflow_sofar.png"</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="images/nimble_workflow_sofar.png" width="1497"></div>
</div>
<div id="but-nimble-gives-full-access-to-the-mcmc-engine" class="section level2" number="2.16">
<h2>
<span class="header-section-number">2.16</span> But <code>nimble</code> gives full access to the MCMC engine<a class="anchor" aria-label="anchor" href="#but-nimble-gives-full-access-to-the-mcmc-engine"><i class="fas fa-link"></i></a>
</h2>
<div class="sourceCode" id="cb39"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">knitr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/knitr/man/include_graphics.html">include_graphics</a></span><span class="op">(</span><span class="st">"images/nimble_workflow.png"</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="images/nimble_workflow.png" width="1497"></div>
<div class="sourceCode" id="cb40"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">knitr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/knitr/man/include_graphics.html">include_graphics</a></span><span class="op">(</span><span class="st">"images/I1bIY06.gif"</span><span class="op">)</span></code></pre></div>
<div class="inline-figure">
<img src="images/I1bIY06.gif"><!-- -->
</div>
</div>
<div id="functions" class="section level2" number="2.17">
<h2>
<span class="header-section-number">2.17</span> Functions<a class="anchor" aria-label="anchor" href="#functions"><i class="fas fa-link"></i></a>
</h2>
<p>Say we want an R function that adds 2 to every value in a vector.</p>
<div class="sourceCode" id="cb41"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">add2</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span>
   <span class="va">x</span> <span class="op">+</span> <span class="fl">2</span> 
<span class="op">}</span>
<span class="va">Radd2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/nimble/man/nimbleRcall.html">nimbleRcall</a></span><span class="op">(</span><span class="kw">function</span><span class="op">(</span><span class="va">x</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/double.html">double</a></span><span class="op">(</span><span class="fl">0</span><span class="op">)</span><span class="op">)</span><span class="op">{</span><span class="op">}</span>, 
                     Rfun <span class="op">=</span> <span class="st">'add2'</span>,
                     returnType <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/double.html">double</a></span><span class="op">(</span><span class="fl">0</span><span class="op">)</span><span class="op">)</span>
<span class="va">demoCode</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/nimble/man/nimbleCode.html">nimbleCode</a></span><span class="op">(</span><span class="op">{</span>
  <span class="va">mu</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">dnorm</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">1</span><span class="op">)</span>
  <span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">n</span><span class="op">)</span> <span class="op">{</span>
    <span class="va">x</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">dnorm</a></span><span class="op">(</span><span class="va">mu</span>, sd <span class="op">=</span> <span class="fl">1</span><span class="op">)</span>
    <span class="va">z</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu">Radd2</span><span class="op">(</span><span class="va">x</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span>
    <span class="op">}</span> 
<span class="op">}</span><span class="op">)</span>

<span class="va">param_names</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/nimble/man/nimble-R-functions.html">c</a></span><span class="op">(</span><span class="st">"mu"</span>, <span class="st">"z"</span><span class="op">)</span>
<span class="va">mcmc.out</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/nimble/man/nimbleMCMC.html">nimbleMCMC</a></span><span class="op">(</span>code <span class="op">=</span> <span class="va">demoCode</span>, 
                      constants <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fl">4</span><span class="op">)</span>,
                      data <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/nimble/man/nimble-R-functions.html">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">1</span>, <span class="op">-</span><span class="fl">2</span>, <span class="fl">1</span>, <span class="fl">2</span><span class="op">)</span><span class="op">)</span>, 
                      inits <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>mu <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span><span class="op">)</span>,
                      monitors <span class="op">=</span> <span class="va">param_names</span>,
                      nchains <span class="op">=</span> <span class="fl">2</span>, 
                      niter <span class="op">=</span> <span class="fl">1000</span>,
                      nburnin <span class="op">=</span> <span class="fl">500</span><span class="op">)</span>
<span class="co">## |-------------|-------------|-------------|-------------|</span>
<span class="co">## |-------------------------------------------------------|</span>
<span class="co">## |-------------|-------------|-------------|-------------|</span>
<span class="co">## |-------------------------------------------------------|</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/caseyyoungflesh/MCMCvis">MCMCvis</a></span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/pkg/MCMCvis/man/MCMCsummary.html">MCMCsummary</a></span><span class="op">(</span>object <span class="op">=</span> <span class="va">mcmc.out</span>, round <span class="op">=</span> <span class="fl">2</span><span class="op">)</span>
<span class="co">##      mean   sd 2.5%  50% 97.5% Rhat n.eff</span>
<span class="co">## mu   0.01 0.45 -0.9 0.03  0.91 1.02   893</span>
<span class="co">## z[1] 1.00 0.00  1.0 1.00  1.00  NaN     0</span>
<span class="co">## z[2] 0.00 0.00  0.0 0.00  0.00  NaN     0</span>
<span class="co">## z[3] 3.00 0.00  3.0 3.00  3.00  NaN     0</span>
<span class="co">## z[4] 4.00 0.00  4.0 4.00  4.00  NaN     0</span></code></pre></div>
<p>Change format to vectorise.</p>
<div class="sourceCode" id="cb42"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">add2</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span>
   <span class="va">x</span> <span class="op">+</span> <span class="fl">2</span> 
<span class="op">}</span>
<span class="va">Radd2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/nimble/man/nimbleRcall.html">nimbleRcall</a></span><span class="op">(</span><span class="kw">function</span><span class="op">(</span><span class="va">x</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/double.html">double</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span><span class="op">)</span><span class="op">{</span><span class="op">}</span>, 
                     Rfun <span class="op">=</span> <span class="st">'add2'</span>,
                     returnType <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/double.html">double</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span><span class="op">)</span>
<span class="va">demoCode</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/nimble/man/nimbleCode.html">nimbleCode</a></span><span class="op">(</span><span class="op">{</span>
  <span class="va">mu</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">dnorm</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">1</span><span class="op">)</span>
  <span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">n</span><span class="op">)</span> <span class="op">{</span>
    <span class="va">x</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">dnorm</a></span><span class="op">(</span><span class="va">mu</span>, sd <span class="op">=</span> <span class="fl">1</span><span class="op">)</span>
    <span class="op">}</span>
    <span class="va">z</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">4</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu">Radd2</span><span class="op">(</span><span class="va">x</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">4</span><span class="op">]</span><span class="op">)</span>
<span class="op">}</span><span class="op">)</span>

<span class="va">param_names</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/nimble/man/nimble-R-functions.html">c</a></span><span class="op">(</span><span class="st">"mu"</span>, <span class="st">"z"</span><span class="op">)</span>
<span class="va">mcmc.out</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/nimble/man/nimbleMCMC.html">nimbleMCMC</a></span><span class="op">(</span>code <span class="op">=</span> <span class="va">demoCode</span>, 
                      constants <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fl">4</span><span class="op">)</span>,
                      data <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/nimble/man/nimble-R-functions.html">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">1</span>, <span class="op">-</span><span class="fl">2</span>, <span class="fl">1</span>, <span class="fl">2</span><span class="op">)</span><span class="op">)</span>, 
                      inits <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>mu <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span><span class="op">)</span>,
                      monitors <span class="op">=</span> <span class="va">param_names</span>,
                      nchains <span class="op">=</span> <span class="fl">2</span>, 
                      niter <span class="op">=</span> <span class="fl">1000</span>,
                      nburnin <span class="op">=</span> <span class="fl">500</span><span class="op">)</span>
<span class="co">## |-------------|-------------|-------------|-------------|</span>
<span class="co">## |-------------------------------------------------------|</span>
<span class="co">## |-------------|-------------|-------------|-------------|</span>
<span class="co">## |-------------------------------------------------------|</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/caseyyoungflesh/MCMCvis">MCMCvis</a></span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/pkg/MCMCvis/man/MCMCsummary.html">MCMCsummary</a></span><span class="op">(</span>object <span class="op">=</span> <span class="va">mcmc.out</span>, round <span class="op">=</span> <span class="fl">2</span><span class="op">)</span>
<span class="co">##      mean   sd  2.5%  50% 97.5% Rhat n.eff</span>
<span class="co">## mu   0.03 0.44 -0.86 0.05  0.93    1  1000</span>
<span class="co">## z[1] 1.00 0.00  1.00 1.00  1.00  NaN     0</span>
<span class="co">## z[2] 0.00 0.00  0.00 0.00  0.00  NaN     0</span>
<span class="co">## z[3] 3.00 0.00  3.00 3.00  3.00  NaN     0</span>
<span class="co">## z[4] 4.00 0.00  4.00 4.00  4.00  NaN     0</span></code></pre></div>
<p>Now have paramater to estimate as parameter of your R function.</p>
<div class="sourceCode" id="cb43"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">add2</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span>
   <span class="va">x</span> <span class="op">+</span> <span class="fl">2</span> 
<span class="op">}</span>
<span class="va">Radd2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/nimble/man/nimbleRcall.html">nimbleRcall</a></span><span class="op">(</span><span class="kw">function</span><span class="op">(</span><span class="va">x</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/double.html">double</a></span><span class="op">(</span><span class="fl">0</span><span class="op">)</span><span class="op">)</span><span class="op">{</span><span class="op">}</span>, 
                     Rfun <span class="op">=</span> <span class="st">'add2'</span>,
                     returnType <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/double.html">double</a></span><span class="op">(</span><span class="fl">0</span><span class="op">)</span><span class="op">)</span>
<span class="va">demoCode</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/nimble/man/nimbleCode.html">nimbleCode</a></span><span class="op">(</span><span class="op">{</span>
  <span class="va">mu</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">dnorm</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">1</span><span class="op">)</span>
  <span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">n</span><span class="op">)</span> <span class="op">{</span><span class="va">x</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">dnorm</a></span><span class="op">(</span><span class="va">mu</span>, sd <span class="op">=</span> <span class="fl">1</span><span class="op">)</span><span class="op">}</span> 
  <span class="va">z</span> <span class="op">&lt;-</span> <span class="fu">Radd2</span><span class="op">(</span><span class="va">mu</span><span class="op">)</span>
<span class="op">}</span><span class="op">)</span>

<span class="va">param_names</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/nimble/man/nimble-R-functions.html">c</a></span><span class="op">(</span><span class="st">"mu"</span>, <span class="st">"z"</span><span class="op">)</span>
<span class="va">mcmc.out</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/nimble/man/nimbleMCMC.html">nimbleMCMC</a></span><span class="op">(</span>code <span class="op">=</span> <span class="va">demoCode</span>, 
                      constants <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fl">4</span><span class="op">)</span>,
                      data <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/nimble/man/nimble-R-functions.html">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">1</span>, <span class="op">-</span><span class="fl">2</span>, <span class="fl">1</span>, <span class="fl">2</span><span class="op">)</span><span class="op">)</span>, 
                      inits <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>mu <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span><span class="op">)</span>,
                      monitors <span class="op">=</span> <span class="va">param_names</span>,
                      nchains <span class="op">=</span> <span class="fl">2</span>, 
                      niter <span class="op">=</span> <span class="fl">1000</span>,
                      nburnin <span class="op">=</span> <span class="fl">500</span><span class="op">)</span>
<span class="co">## |-------------|-------------|-------------|-------------|</span>
<span class="co">## |-------------------------------------------------------|</span>
<span class="co">## |-------------|-------------|-------------|-------------|</span>
<span class="co">## |-------------------------------------------------------|</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/caseyyoungflesh/MCMCvis">MCMCvis</a></span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/pkg/MCMCvis/man/MCMCsummary.html">MCMCsummary</a></span><span class="op">(</span>object <span class="op">=</span> <span class="va">mcmc.out</span>, round <span class="op">=</span> <span class="fl">2</span><span class="op">)</span>
<span class="co">##    mean   sd  2.5%  50% 97.5% Rhat n.eff</span>
<span class="co">## mu 0.02 0.44 -0.87 0.01   0.9    1  1158</span>
<span class="co">## z  2.02 0.44  1.13 2.01   2.9    1  1158</span></code></pre></div>
<p>In general if you do need a nimbleRcall like this, there are a couple of considerations. It is common to need to write a wrapper function, i.e. a function you access via nimbleRcall that calls your actual function of interest with arguments and then return value rearranged as needed. For example, if you just need the eigenvectors, a wrapper function could pick those out and return them. The bigger issue is the returnType declaration: nimble type declarations do not include an R list of type declarations as a nimble type. I think you could use a nimbleList data structure for this purpose. You would have to create a nimbleList type and then use that as the declared returnType. But you would still need to write a wrapper, so that you could convert the list returned from base::eigen into a nimbleList object to return from your wrapper. I hope that makes sense.</p>
<p><a href="https://kenkellner.com/blog/models-with-integrals.html" class="uri">https://kenkellner.com/blog/models-with-integrals.html</a></p>
<p>Same thing w/ global environment.</p>
<div class="sourceCode" id="cb44"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://r-nimble.org">nimble</a></span><span class="op">)</span>
<span class="va">add2</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span>
   <span class="va">x</span> <span class="op">+</span> <span class="fl">2</span> <span class="op">+</span> <span class="va">globvar</span>
<span class="op">}</span>
<span class="fu">add2</span><span class="op">(</span><span class="fl">2</span><span class="op">)</span>
<span class="va">globvar</span> <span class="op">&lt;-</span> <span class="fl">2020</span>
<span class="fu">add2</span><span class="op">(</span><span class="fl">2</span><span class="op">)</span>
<span class="va">Radd2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/nimble/man/nimbleRcall.html">nimbleRcall</a></span><span class="op">(</span><span class="kw">function</span><span class="op">(</span><span class="va">x</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/double.html">double</a></span><span class="op">(</span><span class="fl">0</span><span class="op">)</span><span class="op">)</span><span class="op">{</span><span class="op">}</span>, 
                     Rfun <span class="op">=</span> <span class="st">'add2'</span>,
                     returnType <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/double.html">double</a></span><span class="op">(</span><span class="fl">0</span><span class="op">)</span><span class="op">)</span>
<span class="va">demoCode</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/nimble/man/nimbleCode.html">nimbleCode</a></span><span class="op">(</span><span class="op">{</span>
  <span class="va">mu</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">dnorm</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">1</span><span class="op">)</span>
  <span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">n</span><span class="op">)</span> <span class="op">{</span><span class="va">x</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">dnorm</a></span><span class="op">(</span><span class="va">mu</span>, sd <span class="op">=</span> <span class="fl">1</span><span class="op">)</span><span class="op">}</span> 
  <span class="va">z</span> <span class="op">&lt;-</span> <span class="fu">Radd2</span><span class="op">(</span><span class="va">mu</span><span class="op">)</span>
<span class="op">}</span><span class="op">)</span>

<span class="va">param_names</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/nimble/man/nimble-R-functions.html">c</a></span><span class="op">(</span><span class="st">"mu"</span>, <span class="st">"z"</span><span class="op">)</span>
<span class="va">mcmc.out</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/nimble/man/nimbleMCMC.html">nimbleMCMC</a></span><span class="op">(</span>code <span class="op">=</span> <span class="va">demoCode</span>, 
                       constants <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fl">4</span><span class="op">)</span>,
                       data <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/nimble/man/nimble-R-functions.html">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">1</span>, <span class="op">-</span><span class="fl">2</span>, <span class="fl">1</span>, <span class="fl">2</span><span class="op">)</span><span class="op">)</span>, 
                       inits <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>mu <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span><span class="op">)</span>,
                       monitors <span class="op">=</span> <span class="va">param_names</span>,
                       nchains <span class="op">=</span> <span class="fl">2</span>, 
                       niter <span class="op">=</span> <span class="fl">1000</span>,
                       nburnin <span class="op">=</span> <span class="fl">500</span><span class="op">)</span>
<span class="co">#printErrors()</span>
<span class="co"># pb is y is not recognized</span>
<span class="co">#ls()</span>
<span class="co"># assign y to global env</span>
<span class="co"># https://stackoverflow.com/questions/9726705/assign-multiple-objects-to-globalenv-from-within-a-function</span>
<span class="co">#assign("globvar", 20, envir = .GlobalEnv)</span>

<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/caseyyoungflesh/MCMCvis">MCMCvis</a></span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/pkg/MCMCvis/man/MCMCsummary.html">MCMCsummary</a></span><span class="op">(</span>object <span class="op">=</span> <span class="va">mcmc.out</span>, round <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></code></pre></div>
</div>
<div id="summary-1" class="section level2" number="2.18">
<h2>
<span class="header-section-number">2.18</span> Summary<a class="anchor" aria-label="anchor" href="#summary-1"><i class="fas fa-link"></i></a>
</h2>
<ul>
<li><p>Blabla.</p></li>
<li><p>Reblabla.</p></li>
</ul>
</div>
<div id="suggested-reading-1" class="section level2" number="2.19">
<h2>
<span class="header-section-number">2.19</span> Suggested reading<a class="anchor" aria-label="anchor" href="#suggested-reading-1"><i class="fas fa-link"></i></a>
</h2>
<ul>
<li><p>Official website <a href="https://r-nimble.org">https://r-nimble.org</a></p></li>
<li><p>User Manual <a href="https://r-nimble.org/html_manual/cha-welcome-nimble.html">https://r-nimble.org/html_manual/cha-welcome-nimble.html</a> and <a href="https://r-nimble.org/cheatsheets/NimbleCheatSheet.pdf">cheatsheet</a>.</p></li>
<li><p>Users mailing list <a href="https://groups.google.com/forum/#!forum/nimble-users">https://groups.google.com/forum/#!forum/nimble-users</a></p></li>
<li><p>Training material <a href="https://github.com/nimble-training">https://github.com/nimble-training</a></p></li>
<li><p>Reference to cite when using nimble in a publication:</p></li>
</ul>
<blockquote>
<p>de Valpine, P., D. Turek, C. J. Paciorek, C. Anderson-Bergman, D. Temple Lang, and R. Bodik (2017). <a href="https://arxiv.org/pdf/1505.05093.pdf">Programming With Models: Writing Statistical Algorithms for General Model Structures With NIMBLE</a>. <em>Journal of Computational and Graphical Statistics</em> <strong>26</strong> (2): 403–13.</p>
</blockquote>

</div>
</div>
  <div class="chapter-nav">
<div class="prev"><a href="crashcourse.html"><span class="header-section-number">1</span> Bayesian statistics &amp; MCMC</a></div>
<div class="next"><a href="hmmcapturerecapture.html"><span class="header-section-number">3</span> Hidden Markov models</a></div>
</div></main><div class="col-md-3 col-lg-2 d-none d-md-block sidebar sidebar-chapter">
    <nav id="toc" data-toggle="toc" aria-label="On this page"><h2>On this page</h2>
      <ul class="nav navbar-nav">
<li><a class="nav-link" href="#intronimble"><span class="header-section-number">2</span> NIMBLE</a></li>
<li><a class="nav-link" href="#introduction-2"><span class="header-section-number">2.1</span> Introduction</a></li>
<li><a class="nav-link" href="#what-is-nimble"><span class="header-section-number">2.2</span> What is NIMBLE?</a></li>
<li><a class="nav-link" href="#load-nimble-package"><span class="header-section-number">2.3</span> Load nimble package</a></li>
<li><a class="nav-link" href="#build-model-made-of-likelihood-and-priors"><span class="header-section-number">2.4</span> Build model, made of likelihood and priors</a></li>
<li><a class="nav-link" href="#syntax-whats-newbetterdifferent"><span class="header-section-number">2.5</span> Syntax: what’s new/better/different?</a></li>
<li><a class="nav-link" href="#read-in-data"><span class="header-section-number">2.6</span> Read in data</a></li>
<li><a class="nav-link" href="#distinguish-constants-and-data"><span class="header-section-number">2.7</span> Distinguish constants and data</a></li>
<li><a class="nav-link" href="#specify-initial-values"><span class="header-section-number">2.8</span> Specify initial values</a></li>
<li><a class="nav-link" href="#which-parameters-to-save"><span class="header-section-number">2.9</span> Which parameters to save?</a></li>
<li><a class="nav-link" href="#mcmc-details"><span class="header-section-number">2.10</span> MCMC details</a></li>
<li><a class="nav-link" href="#run-model-tadaa"><span class="header-section-number">2.11</span> Run model, tadaa!</a></li>
<li><a class="nav-link" href="#explore-mcmc-outputs"><span class="header-section-number">2.12</span> Explore MCMC outputs</a></li>
<li><a class="nav-link" href="#numerical-summaries"><span class="header-section-number">2.13</span> Numerical summaries</a></li>
<li><a class="nav-link" href="#trace-and-posterior-density"><span class="header-section-number">2.14</span> Trace and posterior density</a></li>
<li><a class="nav-link" href="#our-nimble-workflow-so-far"><span class="header-section-number">2.15</span> Our nimble workflow so far</a></li>
<li><a class="nav-link" href="#but-nimble-gives-full-access-to-the-mcmc-engine"><span class="header-section-number">2.16</span> But nimble gives full access to the MCMC engine</a></li>
<li><a class="nav-link" href="#functions"><span class="header-section-number">2.17</span> Functions</a></li>
<li><a class="nav-link" href="#summary-1"><span class="header-section-number">2.18</span> Summary</a></li>
<li><a class="nav-link" href="#suggested-reading-1"><span class="header-section-number">2.19</span> Suggested reading</a></li>
</ul>

      <div class="book-extra">
        <ul class="list-unstyled">
<li><a id="book-source" href="https://github.com/oliviergimenez/banana-book/blob/master/nimble.Rmd">View source <i class="fab fa-github"></i></a></li>
          <li><a id="book-edit" href="https://github.com/oliviergimenez/banana-book/edit/master/nimble.Rmd">Edit this page <i class="fab fa-github"></i></a></li>
        </ul>
</div>
    </nav>
</div>

</div>
</div> <!-- .container -->

<footer class="bg-primary text-light mt-5"><div class="container"><div class="row">

  <div class="col-12 col-md-6 mt-3">
    <p>"<strong>Bayesian Analysis of Capture-Recapture Data with Hidden Markov Models</strong>: Theory and Case Studies in R" was written by Olivier Gimenez. It was last built on 2022-01-19.</p>
  </div>

  <div class="col-12 col-md-6 mt-3">
    <p>This book was built by the <a class="text-light" href="https://bookdown.org">bookdown</a> R package.</p>
  </div>

</div></div>
</footer><!-- dynamically load mathjax for compatibility with self-contained --><script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script><script type="text/x-mathjax-config">const popovers = document.querySelectorAll('a.footnote-ref[data-toggle="popover"]');
for (let popover of popovers) {
  const div = document.createElement('div');
  div.setAttribute('style', 'position: absolute; top: 0, left:0; width:0, height:0, overflow: hidden; visibility: hidden;');
  div.innerHTML = popover.getAttribute('data-content');

  var has_math = div.querySelector("span.math");
  if (has_math) {
    document.body.appendChild(div);
    MathJax.Hub.Queue(["Typeset", MathJax.Hub, div]);
    MathJax.Hub.Queue(function() {
      popover.setAttribute('data-content', div.innerHTML);
      document.body.removeChild(div);
    })
  }
}
</script>
</body>
</html>
