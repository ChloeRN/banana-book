<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Chapter 2 NIMBLE tutorial | Bayesian Analysis of Capture-Recapture Data with Hidden Markov Models</title>
<meta name="author" content="Olivier Gimenez">
<meta name="description" content="2.1 Introduction In this second chapter, you will get familiar with NIMBLE, an R package that implements up-to-date MCMC algorithms for fitting complex models. NIMBLE spares you from coding the...">
<meta name="generator" content="bookdown 0.23 with bs4_book()">
<meta property="og:title" content="Chapter 2 NIMBLE tutorial | Bayesian Analysis of Capture-Recapture Data with Hidden Markov Models">
<meta property="og:type" content="book">
<meta property="og:url" content="https://oliviergimenez.github.io/bayesian-cr-workshop/intronimble.html">
<meta property="og:description" content="2.1 Introduction In this second chapter, you will get familiar with NIMBLE, an R package that implements up-to-date MCMC algorithms for fitting complex models. NIMBLE spares you from coding the...">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Chapter 2 NIMBLE tutorial | Bayesian Analysis of Capture-Recapture Data with Hidden Markov Models">
<meta name="twitter:description" content="2.1 Introduction In this second chapter, you will get familiar with NIMBLE, an R package that implements up-to-date MCMC algorithms for fitting complex models. NIMBLE spares you from coding the...">
<!-- JS --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://kit.fontawesome.com/6ecbd6c532.js" crossorigin="anonymous"></script><script src="libs/header-attrs-2.11/header-attrs.js"></script><script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="libs/bootstrap-4.6.0/bootstrap.min.css" rel="stylesheet">
<script src="libs/bootstrap-4.6.0/bootstrap.bundle.min.js"></script><script src="libs/bs3compat-0.3.1/transition.js"></script><script src="libs/bs3compat-0.3.1/tabs.js"></script><script src="libs/bs3compat-0.3.1/bs3compat.js"></script><link href="libs/bs4_book-1.0.0/bs4_book.css" rel="stylesheet">
<script src="libs/bs4_book-1.0.0/bs4_book.js"></script><script src="libs/kePrint-0.0.1/kePrint.js"></script><link href="libs/lightable-0.0.1/lightable.css" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- CSS --><link rel="stylesheet" href="bs4_style.css">
</head>
<body data-spy="scroll" data-target="#toc">

<div class="container-fluid">
<div class="row">
  <header class="col-sm-12 col-lg-3 sidebar sidebar-book"><a class="sr-only sr-only-focusable" href="#content">Skip to main content</a>

    <div class="d-flex align-items-start justify-content-between">
      <h1>
        <a href="index.html" title="Theory and Case Studies in R">Bayesian Analysis of Capture-Recapture Data with Hidden Markov Models</a>:
        <small class="text-muted">Theory and Case Studies in R</small>
      </h1>
      <button class="btn btn-outline-primary d-lg-none ml-2 mt-1" type="button" data-toggle="collapse" data-target="#main-nav" aria-expanded="true" aria-controls="main-nav"><i class="fas fa-bars"></i><span class="sr-only">Show table of contents</span></button>
    </div>

    <div id="main-nav" class="collapse-lg">
      <form role="search">
        <input id="search" class="form-control" type="search" placeholder="Search" aria-label="Search">
</form>

      <nav aria-label="Table of contents"><h2>Table of contents</h2>
        <ul class="book-toc list-unstyled">
<li><a class="" href="index.html">Welcome</a></li>
<li><a class="" href="preface.html">Preface</a></li>
<li><a class="" href="about-the-author.html">About the author</a></li>
<li class="book-part">I. Fundations</li>
<li><a class="" href="introduction.html">Introduction</a></li>
<li><a class="" href="crashcourse.html"><span class="header-section-number">1</span> Bayesian statistics &amp; MCMC</a></li>
<li><a class="active" href="intronimble.html"><span class="header-section-number">2</span> NIMBLE tutorial</a></li>
<li><a class="" href="hmmcapturerecapture.html"><span class="header-section-number">3</span> Hidden Markov models</a></li>
<li class="book-part">II. Transitions</li>
<li><a class="" href="introduction-3.html">Introduction</a></li>
<li><a class="" href="survival.html"><span class="header-section-number">4</span> Survival</a></li>
<li><a class="" href="covariates.html"><span class="header-section-number">5</span> Covariates</a></li>
<li><a class="" href="dispersal.html"><span class="header-section-number">6</span> Dispersal</a></li>
<li><a class="" href="model-selection.html"><span class="header-section-number">7</span> Model selection and validation</a></li>
<li class="book-part">III. States</li>
<li><a class="" href="introduction-4.html">Introduction</a></li>
<li><a class="" href="uncertainty.html"><span class="header-section-number">8</span> State uncertainty</a></li>
<li><a class="" href="hsmm.html"><span class="header-section-number">9</span> Hidden semi-Markov models</a></li>
<li class="book-part">IV. Case studies</li>
<li><a class="" href="introduction-5.html">Introduction</a></li>
<li><a class="" href="tradeoffs.html"><span class="header-section-number">10</span> Life history theory</a></li>
<li><a class="" href="abundance.html"><span class="header-section-number">11</span> Abundance</a></li>
<li><a class="" href="stopover.html"><span class="header-section-number">12</span> Stopover duration</a></li>
<li><a class="" href="individual-dependence.html"><span class="header-section-number">13</span> Individual dependence</a></li>
<li class="book-part">V. Conclusion</li>
<li><a class="" href="take-home-messages.html">Take-home messages</a></li>
<li><a class="" href="faq.html">FAQ</a></li>
<li><a class="" href="references.html">References</a></li>
</ul>

        <div class="book-extra">
          <p><a id="book-repo" href="https://github.com/oliviergimenez/banana-book">View book source <i class="fab fa-github"></i></a></p>
        </div>
      </nav>
</div>
  </header><main class="col-sm-12 col-md-9 col-lg-7" id="content"><div id="intronimble" class="section level1" number="2">
<h1>
<span class="header-section-number">2</span> NIMBLE tutorial<a class="anchor" aria-label="anchor" href="#intronimble"><i class="fas fa-link"></i></a>
</h1>
<div id="introduction-2" class="section level2" number="2.1">
<h2>
<span class="header-section-number">2.1</span> Introduction<a class="anchor" aria-label="anchor" href="#introduction-2"><i class="fas fa-link"></i></a>
</h2>
<p>In this second chapter, you will get familiar with NIMBLE, an R package that implements up-to-date MCMC algorithms for fitting complex models. NIMBLE spares you from coding the MCMC algorithms by hand, and requires only the specification of a likelihood and priors for model parameters. We will illustrate NIMBLE main features with a simple example, but the ideas hold for other problems.</p>
<p><strong>go through <a href="https://r-nimble.org/documentation-2" class="uri">https://r-nimble.org/documentation-2</a> and <a href="https://r-nimble.org/examples" class="uri">https://r-nimble.org/examples</a>; also see workshop FAQ <a href="https://oliviergimenez.github.io/bayesian-cr-workshop/" class="uri">https://oliviergimenez.github.io/bayesian-cr-workshop/</a>; check forum and my gmail</strong></p>
</div>
<div id="what-is-nimble" class="section level2" number="2.2">
<h2>
<span class="header-section-number">2.2</span> What is NIMBLE?<a class="anchor" aria-label="anchor" href="#what-is-nimble"><i class="fas fa-link"></i></a>
</h2>
<p>NIMBLE stands for <strong>N</strong>umerical <strong>I</strong>nference for statistical <strong>M</strong>odels using <strong>B</strong>ayesian and <strong>L</strong>ikelihood <strong>E</strong>stimation. Briefly speaking, NIMBLE is an R package that implements for you MCMC algorithms to generate samples from the posterior distribution of model parameters. Freed from the burden of coding your own MCMC algorithms, you only have to specify a likelihood and priors to apply the Bayes theorem. To do so, NIMBLE uses a syntax very similar to the R syntax, which should make your life easier. This so-called BUGS language is also used by other programs like WinBUGS, OpenBUGS, and JAGS.</p>
<p>So why use NIMBLE you may ask? The short answer is that NIMBLE is capable of so much more! First, you will work from within R, but in the background NIMBLE will translate your code in C++ for (in general) faster computation. Second, NIMBLE extends the BUGS language for writing new functions and statistical distributions of your own, or borrow those written by others. Third, NIMBLE gives you full control of the MCMC samplers, and you may pick other algorithms than the defaults. Fourth, NIMBLE comes with a library of numerical methods other than MCMC algorithms, including sequential Monte Carlo (for particle filtering) and Monte Carlo Expectation Maximization (for maximum likelihood). Last but not least, the development team is friendly and helpful, and based on users’ feedbacks, NIMBLE folks work constantly at improving the package capabilities.</p>
<p><strong>Figure avec logo Nimble</strong></p>
</div>
<div id="getting-started" class="section level2" number="2.3">
<h2>
<span class="header-section-number">2.3</span> Getting started<a class="anchor" aria-label="anchor" href="#getting-started"><i class="fas fa-link"></i></a>
</h2>

<div class="rmdnote">
To run NIMBLE, you will need to:<br>
1. Build a model consisting of a likelihood and priors.<br>
2. Read in some data.<br>
3. Specify parameters you want to make inference about.<br>
4. Pick initial values for parameters to be estimated (for each chain).<br>
5. Provide MCMC details namely the number of chains, the length of the burn-in period and the number of iterations following burn-in.
</div>
<p>First things first, let’s not forget to load the <code>nimble</code> package:</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://r-nimble.org">nimble</a></span><span class="op">)</span></code></pre></div>
<p>Now let’s go back to our example on animal survival from the previous chapter. First step is to build our model by specifying the binomial likelihood and a uniform prior on survival probability <code>theta</code>. We use the <code><a href="https://rdrr.io/pkg/nimble/man/nimbleCode.html">nimbleCode()</a></code> function and wrap code within curly brackets:</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">model</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/nimble/man/nimbleCode.html">nimbleCode</a></span><span class="op">(</span><span class="op">{</span>
  <span class="co"># likelihood</span>
  <span class="va">survived</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/stats/Binomial.html">dbinom</a></span><span class="op">(</span><span class="va">theta</span>, <span class="va">released</span><span class="op">)</span>
  <span class="co"># prior</span>
  <span class="va">theta</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">dunif</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span>
  <span class="co"># derived quantity</span>
  <span class="va">lifespan</span> <span class="op">&lt;-</span> <span class="op">-</span><span class="fl">1</span><span class="op">/</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="va">theta</span><span class="op">)</span>
<span class="op">}</span><span class="op">)</span></code></pre></div>
<p>You can check that the <code>model</code> R object contains your code:</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">model</span>
<span class="co">## {</span>
<span class="co">##     survived ~ dbinom(theta, released)</span>
<span class="co">##     theta ~ dunif(0, 1)</span>
<span class="co">##     lifespan &lt;- -1/log(theta)</span>
<span class="co">## }</span></code></pre></div>
<p>In the code above, <code>survived</code> and <code>released</code> are known, only <code>theta</code> needs to be estimated. The line <code>survived ~ dbinom(theta, released)</code> states that the number of successes or animals that have survived over winter <code>survived</code> is distributed as (that’s the <code><a href="https://rdrr.io/r/base/tilde.html">~</a></code>) as a binomial with <code>released</code> trials and probability of success or survival <code>theta</code>. Then the line <code>theta ~ dunif(0, 1)</code> assigns a uniform between 0 and 1 as a prior distribution to the survival probability. This is all you need, a likelihood and priors for model parameters, NIMBLE knows the Bayes theorem. The last line <code>lifespan &lt;- - 1/log(theta)</code> calculates a quantity derived from <code>theta</code>, which is the expected lifespan assuming constant survival<a class="footnote-ref" tabindex="0" data-toggle="popover" data-content="&lt;p&gt;Cook LM, Brower LP, Croze HJ (1967) The accuracy of a population estimation from multiple recapture data. J Anim Ecol 36:57–60&lt;/p&gt;"><sup>17</sup></a>.</p>
<p>A few comments:</p>
<ul>
<li><p>The most common distributions are available in NIMBLE. Among others, we will use later in the book <code>dbeta</code>, <code>dmultinom</code> and <code>dnorm</code>. If you cannot find what you need in NIMBLE, you can write your own distribution as illustrated in Section <a href="#write-your-own-distribution"><strong>??</strong></a>.</p></li>
<li><p>It does not matter in what order you write each line of code, NIMBLE uses what is called a declarative language for building models. In brief, you write code that tells NIMBLE what you want to achieve, and not how to get there. In contrast, an imperative language requires that you write what you want your program to do step by step.</p></li>
<li>
<p>You can think of models in NIMBLE as graphs as in Figure <a href="intronimble.html#fig:dag-survival">2.1</a>. A graph is made of relations (or edges) that can be of two types. A stochastic relation is signaled by a <code><a href="https://rdrr.io/r/base/tilde.html">~</a></code> sign and defines a random variable in the model, such as <code>survived</code> or <code>theta</code>. A deterministic relation is signaled by a <code><a href="https://rdrr.io/r/base/assignOps.html">&lt;-</a></code> sign, like <code>lifespan</code>. Relations define nodes on the left - the children - in terms of other nodes on the right - the parents, and relations are directed edges from parents to children. Such graphs are called directed acyclic graph or DAG.</p>
<div class="figure">
<span style="display:block;" id="fig:dag-survival"></span>
<img src="banana-book_files/figure-html/dag-survival-1.png" alt="Graph of the animal survival model. Survived is a stochastic node defined by its parents `released` and `theta`, while `lifespan` is a deterministic node the value of which is defined exactly by the value of its parent `theta`." width="672"><p class="caption">
Figure 2.1: Graph of the animal survival model. Survived is a stochastic node defined by its parents <code>released</code> and <code>theta</code>, while <code>lifespan</code> is a deterministic node the value of which is defined exactly by the value of its parent <code>theta</code>.
</p>
</div>
</li>
</ul>
<p>Second step in our workflow is to read in some data. We use a list in which each component corresponds to a known quantity in the model:</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">my.data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>released <span class="op">=</span> <span class="fl">57</span>, survived <span class="op">=</span> <span class="fl">19</span><span class="op">)</span></code></pre></div>
<p>You can proceed with data passed this way, but you should know a little more about how NIMBLE sees data. NIMBLE distinguishes data and constants. Constants are values that do not change, e.g. vectors of known index values or the indices used to define for-loops. Data are values that you might want to change, basically anything that only appears on the left of a <code><a href="https://rdrr.io/r/base/tilde.html">~</a></code>. Declaring relevant values as constants is better for computational efficiency, but it is easy to forget, and fortunately NIMBLE will by itself distinguish data and constants. <strong>More details? Forward reference to an example with constants?</strong></p>
<!-- In passing say that full indexing is needed, you cannot let NIMBLE guess dimensions. -->
<!-- Ici on reprend le modèle simple du dessus, et on l'exprime un peu différemment pour illustrer qqs autres features de NIMBLE: i) loops, ii) distinction between constants and data. The binomial is a sum of independent Bernoulli outcomes with same probability. the Like flipping a coin for each individual and get a survivor with prob theta. Here survived is. Going back to our animal survival example, it means that the likelihood can be written as a Bernoulli random variable taking value 1 if animal survived, and 0 otherwise. **Voir dans annexe Hobbs**. E.g. `survived[1] ~ dbern(theta)` up to `survived[59] ~ dbern(theta)`. Likelihood contribution of individuals. Loops is the product. Iid. Instead of duplicating the same line of code `survived[i] ~ dbern(theta)` we use a loop. -->
<!-- ```{r} -->
<!-- model <- nimbleCode({ -->
<!--   # likelihood -->
<!--   for (i in 1:released){ -->
<!--     survived[i] ~ dbern(theta) -->
<!--   } -->
<!--   # prior -->
<!--   theta ~ dunif(0, 1) -->
<!-- }) -->
<!-- ``` -->
<!-- **If you try nimbleMCMC it won't work. This is because we ned to distinguish data from constants. Uncomment code.** -->
<!-- Distinguih constants and data. To Nimble, not all "data" is data... -->
<!-- ```{r} -->
<!-- my.constants <- list(released = 57) -->
<!-- my.data <- list(survived = 19) -->
<!-- ``` -->
<!-- ```{r, eval = FALSE} -->
<!-- mcmc.output <- nimbleMCMC(code = model, -->
<!--                           data = my.data, -->
<!--                           constants = my.constants, -->
<!--                           inits = initial.values, -->
<!--                           monitors = parameters.to.save, -->
<!--                           niter = n.iter, -->
<!--                           nburnin = n.burnin, -->
<!--                           nchains = n.chains) -->
<!-- ``` -->
<!-- ```{r} -->
<!-- my.data <- list(survived = c(rep(1,19), rep(0,57-19))) -->
<!-- my.constants <- list(released = 57) -->
<!-- ``` -->
<!-- The rest is the same. Steps 3, 4 and 5. -->
<!-- ```{r} -->
<!-- parameters.to.save <- c("theta", "life_expectancy") -->
<!-- initial.values <- function() list(theta = runif(1,0,1)) -->
<!-- n.iter <- 5000 -->
<!-- n.burnin <- 1000 -->
<!-- n.chains <- 3 -->
<!-- ``` -->
<!-- Run model, add argument `constants = my.constants`. -->
<!-- ```{r} -->
<!-- mcmc.output <- nimbleMCMC(code = model, -->
<!--                           data = my.data, -->
<!--                           constants = my.constants, -->
<!--                           inits = initial.values, -->
<!--                           monitors = parameters.to.save, -->
<!--                           niter = n.iter, -->
<!--                           nburnin = n.burnin, -->
<!--                           nchains = n.chains) -->
<!-- ``` -->
<p>Third step is to tell NIMBLE which nodes in your model you would like to keep track of, in other words the quantities you’d like to do inference about. In our model we want survival <code>theta</code> and <code>lifespan</code>:</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">parameters.to.save</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/nimble/man/nimble-R-functions.html">c</a></span><span class="op">(</span><span class="st">"theta"</span>, <span class="st">"lifespan"</span><span class="op">)</span></code></pre></div>
<p>In general you have many quantities in your model, including some of little interest that are not worth displaying, and having full control on verbosity will prove handy.</p>
<p>Fourth step is to specify initial values for all model parameters. To make sure that the MCMC algorithm explores the posterior distribution, we start different chains with different parameter values. You can specify initial values for each chain in a list and put them in yet another list:</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">init1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>theta <span class="op">=</span> <span class="fl">0.1</span><span class="op">)</span>
<span class="va">init2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>theta <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span>
<span class="va">init3</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>theta <span class="op">=</span> <span class="fl">0.9</span><span class="op">)</span>
<span class="va">initial.values</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="va">init1</span>, <span class="va">init2</span>, <span class="va">init3</span><span class="op">)</span>
<span class="va">initial.values</span>
<span class="co">## [[1]]</span>
<span class="co">## [[1]]$theta</span>
<span class="co">## [1] 0.1</span>
<span class="co">## </span>
<span class="co">## </span>
<span class="co">## [[2]]</span>
<span class="co">## [[2]]$theta</span>
<span class="co">## [1] 0.5</span>
<span class="co">## </span>
<span class="co">## </span>
<span class="co">## [[3]]</span>
<span class="co">## [[3]]$theta</span>
<span class="co">## [1] 0.9</span></code></pre></div>
<p>Alternatively, you can write a simple R function that generates random initial values:</p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">initial.values</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>theta <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">0</span>,<span class="fl">1</span><span class="op">)</span><span class="op">)</span>
<span class="fu">initial.values</span><span class="op">(</span><span class="op">)</span>
<span class="co">## $theta</span>
<span class="co">## [1] 0.8356</span></code></pre></div>
<p>Firth and last step, you need to tell NIMBLE the number of chains to run, say <code>n.chain</code>, how long the burn-in period should be, say <code>n.burnin</code>, and the number of iterations following the burn-in period to be used for posterior inference. In NIMBLE, you specify the total number of iterations, say <code>n.iter</code>, so that the number of posterior samples per chain is <code>n.iter - n.burnin</code>. NIMBLE also allows discarding samples after burn-in, a procedure known as thinning, which I will not use in this book<a class="footnote-ref" tabindex="0" data-toggle="popover" data-content="&lt;p&gt;Link, W.A. and Eaton, M.J. (2012), On thinning of chains in MCMC. Methods in Ecology and Evolution, 3: 112-115.&lt;/p&gt;"><sup>18</sup></a></p>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">n.iter</span> <span class="op">&lt;-</span> <span class="fl">5000</span>
<span class="va">n.burnin</span> <span class="op">&lt;-</span> <span class="fl">1000</span>
<span class="va">n.chains</span> <span class="op">&lt;-</span> <span class="fl">3</span></code></pre></div>
<p>We now have all the ingredients to run model, that is to sample in the posterior distribution of model parameters using MCMC simulations. This is accomplished using function <code><a href="https://rdrr.io/pkg/nimble/man/nimbleMCMC.html">nimbleMCMC()</a></code>:</p>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">mcmc.output</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/nimble/man/nimbleMCMC.html">nimbleMCMC</a></span><span class="op">(</span>code <span class="op">=</span> <span class="va">model</span>,
                          data <span class="op">=</span> <span class="va">my.data</span>,
                          inits <span class="op">=</span> <span class="va">initial.values</span>,
                          monitors <span class="op">=</span> <span class="va">parameters.to.save</span>,
                          niter <span class="op">=</span> <span class="va">n.iter</span>,
                          nburnin <span class="op">=</span> <span class="va">n.burnin</span>,
                          nchains <span class="op">=</span> <span class="va">n.chains</span><span class="op">)</span>
<span class="co">## |-------------|-------------|-------------|-------------|</span>
<span class="co">## |-------------------------------------------------------|</span>
<span class="co">## |-------------|-------------|-------------|-------------|</span>
<span class="co">## |-------------------------------------------------------|</span>
<span class="co">## |-------------|-------------|-------------|-------------|</span>
<span class="co">## |-------------------------------------------------------|</span></code></pre></div>
<p>NIMBLE goes through several steps that we will explain in Section <a href="#advanced-stuff"><strong>??</strong></a>. <strong>Cite correct section</strong> Function <code><a href="https://rdrr.io/pkg/nimble/man/nimbleMCMC.html">nimbleMCMC()</a></code> takes other arguments that you might find useful. For example, you can suppress the progress bar if you find it to depressing when running long simulations with <code>progressBar = FALSE</code>. You can also get a summary of the outputs by specifying <code>summary = TRUE</code>. Check <code><a href="https://rdrr.io/pkg/nimble/man/nimbleMCMC.html">?nimbleMCMC</a></code> for more details.</p>
<p>Now let’s inspect what we have in <code>mcmc.output</code>.</p>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/utils/str.html">str</a></span><span class="op">(</span><span class="va">mcmc.output</span><span class="op">)</span>
<span class="co">## List of 3</span>
<span class="co">##  $ chain1: num [1:4000, 1] 0.36 0.432 0.374 0.374 0.412 ...</span>
<span class="co">##   ..- attr(*, "dimnames")=List of 2</span>
<span class="co">##   .. ..$ : NULL</span>
<span class="co">##   .. ..$ : chr "theta"</span>
<span class="co">##  $ chain2: num [1:4000, 1] 0.325 0.325 0.384 0.384 0.475 ...</span>
<span class="co">##   ..- attr(*, "dimnames")=List of 2</span>
<span class="co">##   .. ..$ : NULL</span>
<span class="co">##   .. ..$ : chr "theta"</span>
<span class="co">##  $ chain3: num [1:4000, 1] 0.42 0.296 0.337 0.399 0.399 ...</span>
<span class="co">##   ..- attr(*, "dimnames")=List of 2</span>
<span class="co">##   .. ..$ : NULL</span>
<span class="co">##   .. ..$ : chr "theta"</span></code></pre></div>
<p>The R object <code>mcmc.output</code> is a list with three components, one for each MCMC chain. Let’s have a look to <code>chain1</code> for example.</p>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/pkg/nimble/man/nimDim.html">dim</a></span><span class="op">(</span><span class="va">mcmc.output</span><span class="op">$</span><span class="va">chain1</span><span class="op">)</span>
<span class="co">## [1] 4000    1</span>
<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">mcmc.output</span><span class="op">$</span><span class="va">chain1</span><span class="op">)</span>
<span class="co">##       theta</span>
<span class="co">## [1,] 0.3604</span>
<span class="co">## [2,] 0.4323</span>
<span class="co">## [3,] 0.3739</span>
<span class="co">## [4,] 0.3739</span>
<span class="co">## [5,] 0.4125</span>
<span class="co">## [6,] 0.4125</span></code></pre></div>
<p>Each component of the list is a matrix. In rows, you have 4000 samples from the posterior distribution of <code>theta</code>, which corresponds to <code>n.iter - n.burnin</code>. In columns, you have the quantities we monitor, <code>theta</code> and <code>lifespan</code>. From there, you can compute the posterior mean of <code>theta</code>:</p>
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">mcmc.output</span><span class="op">$</span><span class="va">chain1</span><span class="op">[</span>,<span class="st">'theta'</span><span class="op">]</span><span class="op">)</span>
<span class="co">## [1] 0.3402</span></code></pre></div>
<p>You can also obtain the 95% credible interval for <code>theta</code>:</p>
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/stats/quantile.html">quantile</a></span><span class="op">(</span><span class="va">mcmc.output</span><span class="op">$</span><span class="va">chain1</span><span class="op">[</span>,<span class="st">'theta'</span><span class="op">]</span>, probs <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/nimble/man/nimble-R-functions.html">c</a></span><span class="op">(</span><span class="fl">2.5</span>, <span class="fl">97.5</span><span class="op">)</span><span class="op">/</span><span class="fl">100</span><span class="op">)</span>
<span class="co">##   2.5%  97.5% </span>
<span class="co">## 0.2265 0.4575</span></code></pre></div>
<p>Let’s visualise the posterior distribution of <code>theta</code> with a histogram:</p>
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">mcmc.output</span> <span class="op">%&gt;%</span>
  <span class="fu">as_tibble</span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">geom_histogram</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">chain1</span><span class="op">[</span>,<span class="st">"theta"</span><span class="op">]</span><span class="op">)</span>, color <span class="op">=</span> <span class="st">"white"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">labs</span><span class="op">(</span>x <span class="op">=</span> <span class="st">"survival probability"</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="banana-book_files/figure-html/unnamed-chunk-43-1.png" width="672"></div>
<p>There are less painful ways of doing posterior inference. In this book, I will use the R package <code>MCMCvis</code><a class="footnote-ref" tabindex="0" data-toggle="popover" data-content='&lt;p&gt;&lt;a href="https://github.com/caseyyoungflesh/MCMCvis" class="uri"&gt;https://github.com/caseyyoungflesh/MCMCvis&lt;/a&gt;&lt;/p&gt;'><sup>19</sup></a> to summarise and visualize MCMC outputs, but there are other perfectly valid options out there like <code>ggmcmc</code><a class="footnote-ref" tabindex="0" data-toggle="popover" data-content="&lt;p&gt;Fernández-i-Marín, X. (2016). ggmcmc: Analysis of MCMC Samples and Bayesian Inference. Journal of Statistical Software, 70(9), 1–20&lt;/p&gt;"><sup>20</sup></a> and <code>basicMCMCplots</code><a class="footnote-ref" tabindex="0" data-toggle="popover" data-content='&lt;p&gt;&lt;a href="https://cran.r-project.org/web/packages/basicMCMCplots/index.html" class="uri"&gt;https://cran.r-project.org/web/packages/basicMCMCplots/index.html&lt;/a&gt;&lt;/p&gt;'><sup>21</sup></a>. <strong>Shall I demonstrate these other options?.</strong></p>
<!-- Finally we want to look at our samples. NIMBLE returns samples as a simple matrix with named columns. There are numerous packages for processing MCMC output. If you want to use the coda package, you can convert a matrix to a coda mcmc object like this: -->
<!-- library(coda) -->
<!-- coda.samples <- as.mcmc(samples) -->
<!-- Alternatively, if you call nimbleMCMC with the argument samplesAsCodaMCMC = TRUE, the samples will be returned as a coda object. -->
<p>Let’s load the package <code>MCMCvis</code>:</p>
<div class="sourceCode" id="cb31"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/caseyyoungflesh/MCMCvis">MCMCvis</a></span><span class="op">)</span></code></pre></div>
<p>To get the most common numerical summaries, the function <code><a href="https://rdrr.io/pkg/MCMCvis/man/MCMCsummary.html">MCMCsummary()</a></code> does the job:</p>
<div class="sourceCode" id="cb32"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/pkg/MCMCvis/man/MCMCsummary.html">MCMCsummary</a></span><span class="op">(</span>object <span class="op">=</span> <span class="va">mcmc.output</span>, round <span class="op">=</span> <span class="fl">2</span><span class="op">)</span>
<span class="co">##       mean   sd 2.5%  50% 97.5% Rhat n.eff</span>
<span class="co">## theta 0.34 0.06 0.23 0.34  0.46    1  2764</span></code></pre></div>
<p>You can use a caterpillar plot to visualise the posterior distributions of <code>theta</code> with <code><a href="https://rdrr.io/pkg/MCMCvis/man/MCMCplot.html">MCMCplot()</a></code>:</p>
<div class="sourceCode" id="cb33"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/pkg/MCMCvis/man/MCMCplot.html">MCMCplot</a></span><span class="op">(</span>object <span class="op">=</span> <span class="va">mcmc.output</span>, 
         params <span class="op">=</span> <span class="st">'theta'</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="banana-book_files/figure-html/unnamed-chunk-46-1.png" width="672"></div>
<p>The point represents the posterior median, the thick line is the 50% credible interval and the thin line the 95% credible interval.</p>
<p>The trace and posterior density of theta can be obtained with <code><a href="https://rdrr.io/pkg/MCMCvis/man/MCMCtrace.html">MCMCtrace()</a></code>:</p>
<div class="sourceCode" id="cb34"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/pkg/MCMCvis/man/MCMCtrace.html">MCMCtrace</a></span><span class="op">(</span>object <span class="op">=</span> <span class="va">mcmc.output</span>,
          pdf <span class="op">=</span> <span class="cn">FALSE</span>, <span class="co"># no export to PDF</span>
          ind <span class="op">=</span> <span class="cn">TRUE</span>, <span class="co"># separate density lines per chain</span>
          params <span class="op">=</span> <span class="st">"theta"</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="banana-book_files/figure-html/unnamed-chunk-47-1.png" width="672"></div>
<p>You can also add the diagnostics of convergence we discussed in the previous chapter:</p>
<div class="sourceCode" id="cb35"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/pkg/MCMCvis/man/MCMCtrace.html">MCMCtrace</a></span><span class="op">(</span>object <span class="op">=</span> <span class="va">mcmc.output</span>,
          pdf <span class="op">=</span> <span class="cn">FALSE</span>,
          ind <span class="op">=</span> <span class="cn">TRUE</span>,
          Rhat <span class="op">=</span> <span class="cn">TRUE</span>, <span class="co"># add Rhat</span>
          n.eff <span class="op">=</span> <span class="cn">TRUE</span>, <span class="co"># add eff sample size</span>
          params <span class="op">=</span> <span class="st">"theta"</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="banana-book_files/figure-html/unnamed-chunk-48-1.png" width="672"></div>
<p>We calculated lifespan directly in our model with <code>lifespan &lt;- -1/log(theta)</code>. But you can also calculate this quantity from outside NIMBLE. This is a nice by-product of using MCMC simulations: you can obtain the posterior distribution of any quantity that is function of your model parameters by applying this function to samples from the posterior distribution of these parameters. In our example, all you need is samples from the posterior distribution of <code>theta</code>, which we pool between the three chains with:</p>
<div class="sourceCode" id="cb36"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">theta_samples</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/nimble/man/nimble-R-functions.html">c</a></span><span class="op">(</span><span class="va">mcmc.output</span><span class="op">$</span><span class="va">chain1</span><span class="op">[</span>,<span class="st">'theta'</span><span class="op">]</span>, 
                   <span class="va">mcmc.output</span><span class="op">$</span><span class="va">chain2</span><span class="op">[</span>,<span class="st">'theta'</span><span class="op">]</span>,
                   <span class="va">mcmc.output</span><span class="op">$</span><span class="va">chain3</span><span class="op">[</span>,<span class="st">'theta'</span><span class="op">]</span><span class="op">)</span></code></pre></div>
<p>To get samples from the posterior distribution of lifespan, we apply the function to calculate lifespan to the samples from the posterior distribution of survival:</p>
<div class="sourceCode" id="cb37"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">lifespan</span> <span class="op">&lt;-</span> <span class="op">-</span><span class="fl">1</span><span class="op">/</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="va">theta_samples</span><span class="op">)</span></code></pre></div>
<p>As usual then, you can calculate the posterior mean and 95% credible interval:</p>
<div class="sourceCode" id="cb38"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">lifespan</span><span class="op">)</span>
<span class="co">## [1] 0.9379</span>
<span class="fu"><a href="https://rdrr.io/r/stats/quantile.html">quantile</a></span><span class="op">(</span><span class="va">lifespan</span>, probs <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/nimble/man/nimble-R-functions.html">c</a></span><span class="op">(</span><span class="fl">2.5</span>, <span class="fl">97.5</span><span class="op">)</span><span class="op">/</span><span class="fl">100</span><span class="op">)</span>
<span class="co">##   2.5%  97.5% </span>
<span class="co">## 0.6767 1.2885</span></code></pre></div>
<p>You can also visualise the posterior distribution of lifespan:</p>
<div class="sourceCode" id="cb39"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">lifespan</span> <span class="op">%&gt;%</span>
  <span class="fu">as_tibble</span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">geom_histogram</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">value</span><span class="op">)</span>, color <span class="op">=</span> <span class="st">"white"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">labs</span><span class="op">(</span>x <span class="op">=</span> <span class="st">"lifespan"</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="banana-book_files/figure-html/unnamed-chunk-52-1.png" width="672"></div>
<p>Now you’re good to go. The NIMBLE workflow you now have available with <code><a href="https://rdrr.io/pkg/nimble/man/nimbleMCMC.html">nimbleMCMC()</a></code> allows you to build models and make inference. In the next section, we cover some advanced material that you may skip and go back to if you need it.</p>
</div>
<div id="functions-in-nimble" class="section level2" number="2.4">
<h2>
<span class="header-section-number">2.4</span> Functions in NIMBLE<a class="anchor" aria-label="anchor" href="#functions-in-nimble"><i class="fas fa-link"></i></a>
</h2>
<p>NIMBLE provides <code>nimbleFunctions</code> for …</p>
<p><a href="https://r-nimble.org/html_manual/cha-RCfunctions.html#sec:RC-intro" class="uri">https://r-nimble.org/html_manual/cha-RCfunctions.html#sec:RC-intro</a></p>
<div class="sourceCode" id="cb40"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">computeLifespan</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/nimble/man/nimbleFunction.html">nimbleFunction</a></span><span class="op">(</span>
    run <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">theta</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/double.html">double</a></span><span class="op">(</span><span class="fl">0</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span> <span class="co"># type declarations</span>
        <span class="va">ans</span> <span class="op">&lt;-</span> <span class="op">-</span><span class="fl">1</span><span class="op">/</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="va">theta</span><span class="op">)</span>
        <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">ans</span><span class="op">)</span>
        <span class="fu">returnType</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/double.html">double</a></span><span class="op">(</span><span class="fl">0</span><span class="op">)</span><span class="op">)</span>  <span class="co"># return type declaration</span>
    <span class="op">}</span> <span class="op">)</span></code></pre></div>
<p>The x = double(0) argument and returnType(double(0)) establish that the input and output will both be zero-dimensional (scalar) numbers.</p>
<div class="sourceCode" id="cb41"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">computeLifespan</span><span class="op">(</span><span class="fl">0.8</span><span class="op">)</span>
<span class="co">## [1] 4.481</span></code></pre></div>
<p>You can compile it and use the C++ code for faster computation.</p>
<div class="sourceCode" id="cb42"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">CcomputeLifespan</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/nimble/man/compileNimble.html">compileNimble</a></span><span class="op">(</span><span class="va">computeLifespan</span><span class="op">)</span>
<span class="fu">CcomputeLifespan</span><span class="op">(</span><span class="fl">0.8</span><span class="op">)</span>
<span class="co">## [1] 4.481</span></code></pre></div>
<p>Or you can use your function in a model.</p>
<div class="sourceCode" id="cb43"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">model</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/nimble/man/nimbleCode.html">nimbleCode</a></span><span class="op">(</span><span class="op">{</span>
  <span class="co"># likelihood</span>
  <span class="va">survived</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/stats/Binomial.html">dbinom</a></span><span class="op">(</span><span class="va">theta</span>, <span class="va">released</span><span class="op">)</span>
  <span class="co"># prior</span>
  <span class="va">theta</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">dunif</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span>
  <span class="co"># derived quantity</span>
  <span class="va">life_expectancy</span> <span class="op">&lt;-</span> <span class="fu">computeLifespan</span><span class="op">(</span><span class="va">theta</span><span class="op">)</span>
<span class="op">}</span><span class="op">)</span></code></pre></div>
<p>Rest is unchanged.</p>
<div class="sourceCode" id="cb44"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">my.data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>survived <span class="op">=</span> <span class="fl">19</span>, released <span class="op">=</span> <span class="fl">57</span><span class="op">)</span>
<span class="va">parameters.to.save</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/nimble/man/nimble-R-functions.html">c</a></span><span class="op">(</span><span class="st">"theta"</span>, <span class="st">"life_expectancy"</span><span class="op">)</span>
<span class="va">initial.values</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>theta <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">0</span>,<span class="fl">1</span><span class="op">)</span><span class="op">)</span>
<span class="va">n.iter</span> <span class="op">&lt;-</span> <span class="fl">5000</span>
<span class="va">n.burnin</span> <span class="op">&lt;-</span> <span class="fl">1000</span>
<span class="va">n.chains</span> <span class="op">&lt;-</span> <span class="fl">3</span>
<span class="va">mcmc.output</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/nimble/man/nimbleMCMC.html">nimbleMCMC</a></span><span class="op">(</span>code <span class="op">=</span> <span class="va">model</span>,
                          data <span class="op">=</span> <span class="va">my.data</span>,
                          inits <span class="op">=</span> <span class="va">initial.values</span>,
                          monitors <span class="op">=</span> <span class="va">parameters.to.save</span>,
                          niter <span class="op">=</span> <span class="va">n.iter</span>,
                          nburnin <span class="op">=</span> <span class="va">n.burnin</span>,
                          nchains <span class="op">=</span> <span class="va">n.chains</span><span class="op">)</span>
<span class="co">## |-------------|-------------|-------------|-------------|</span>
<span class="co">## |-------------------------------------------------------|</span>
<span class="co">## |-------------|-------------|-------------|-------------|</span>
<span class="co">## |-------------------------------------------------------|</span>
<span class="co">## |-------------|-------------|-------------|-------------|</span>
<span class="co">## |-------------------------------------------------------|</span>
<span class="fu"><a href="https://rdrr.io/pkg/MCMCvis/man/MCMCsummary.html">MCMCsummary</a></span><span class="op">(</span>object <span class="op">=</span> <span class="va">mcmc.output</span>, round <span class="op">=</span> <span class="fl">2</span><span class="op">)</span>
<span class="co">##                 mean   sd 2.5%  50% 97.5% Rhat n.eff</span>
<span class="co">## life_expectancy 0.93 0.16 0.66 0.92  1.30    1  2909</span>
<span class="co">## theta           0.34 0.06 0.22 0.34  0.46    1  2714</span></code></pre></div>
<p>Chapter 11 of the NIMBLE manual.</p>
<p>Distribution functions : <a href="https://r-nimble.org/html_manual/cha-RCfunctions.html#sec:nimble-dist-funs" class="uri">https://r-nimble.org/html_manual/cha-RCfunctions.html#sec:nimble-dist-funs</a></p>
<p>Supports flow control: if-then-else, for, while, and stop</p>
<p>You can R functions within NIMBLE. From packages for example, or complex function you don’t feel like recoding as nimbleFunctions. You lose the compilation and speed, but convenient and flexible even though slow.</p>
<p>Say we want an R function that adds 2 to every value in a vector.</p>
<div class="sourceCode" id="cb45"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">calculate_life_expectancy</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span>
   <span class="op">-</span><span class="fl">1</span><span class="op">/</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span>
<span class="op">}</span></code></pre></div>
<p>This function can be any function from R packages, easier to call with <code>name_package::my_function()</code>.</p>
<p>Now a wrapper.</p>
<div class="sourceCode" id="cb46"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">Rcalculate_life_expectancy</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/nimble/man/nimbleRcall.html">nimbleRcall</a></span><span class="op">(</span><span class="kw">function</span><span class="op">(</span><span class="va">x</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/double.html">double</a></span><span class="op">(</span><span class="fl">0</span><span class="op">)</span><span class="op">)</span><span class="op">{</span><span class="op">}</span>, 
                     Rfun <span class="op">=</span> <span class="st">'calculate_life_expectancy'</span>,
                     returnType <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/double.html">double</a></span><span class="op">(</span><span class="fl">0</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p><strong>Explain format. double(0), double(1), double(2). Best advice is to have a look to other functions.</strong></p>
<div class="sourceCode" id="cb47"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">model</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/nimble/man/nimbleCode.html">nimbleCode</a></span><span class="op">(</span><span class="op">{</span>
  <span class="co"># likelihood</span>
  <span class="va">survived</span> <span class="op">~</span> <span class="fu">dbern</span><span class="op">(</span><span class="va">theta</span><span class="op">)</span>
  <span class="co"># prior</span>
  <span class="va">theta</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">dunif</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span>
  <span class="va">life_expectancy</span> <span class="op">&lt;-</span> <span class="fu">Rcalculate_life_expectancy</span><span class="op">(</span><span class="va">theta</span><span class="op">)</span>
<span class="op">}</span><span class="op">)</span></code></pre></div>
<p>Comment on the call to function <code>Rcalculate_life_expectancy()</code>.</p>
<p>Rest is unchanged.</p>
<div class="sourceCode" id="cb48"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">my.data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>survived <span class="op">=</span> <span class="fl">19</span>, released <span class="op">=</span> <span class="fl">57</span><span class="op">)</span>
<span class="va">parameters.to.save</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/nimble/man/nimble-R-functions.html">c</a></span><span class="op">(</span><span class="st">"theta"</span>, <span class="st">"life_expectancy"</span><span class="op">)</span>
<span class="va">initial.values</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>theta <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">0</span>,<span class="fl">1</span><span class="op">)</span><span class="op">)</span>
<span class="va">n.iter</span> <span class="op">&lt;-</span> <span class="fl">5000</span>
<span class="va">n.burnin</span> <span class="op">&lt;-</span> <span class="fl">1000</span>
<span class="va">n.chains</span> <span class="op">&lt;-</span> <span class="fl">3</span>
<span class="va">mcmc.output</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/nimble/man/nimbleMCMC.html">nimbleMCMC</a></span><span class="op">(</span>code <span class="op">=</span> <span class="va">model</span>,
                          data <span class="op">=</span> <span class="va">my.data</span>,
                          inits <span class="op">=</span> <span class="va">initial.values</span>,
                          monitors <span class="op">=</span> <span class="va">parameters.to.save</span>,
                          niter <span class="op">=</span> <span class="va">n.iter</span>,
                          nburnin <span class="op">=</span> <span class="va">n.burnin</span>,
                          nchains <span class="op">=</span> <span class="va">n.chains</span><span class="op">)</span>
<span class="co">## Infinite values were detected in model variable: logProb_survived.</span>
<span class="co">## warning: logProb of data node survived: logProb is -Inf.</span>
<span class="co">## |-------------|-------------|-------------|-------------|</span>
<span class="co">## |-------------------------------------------------------|</span>
<span class="co">## warning: logProb of data node survived: logProb is -Inf.</span>
<span class="co">## |-------------|-------------|-------------|-------------|</span>
<span class="co">## |-------------------------------------------------------|</span>
<span class="co">## warning: logProb of data node survived: logProb is -Inf.</span>
<span class="co">## |-------------|-------------|-------------|-------------|</span>
<span class="co">## |-------------------------------------------------------|</span></code></pre></div>
<p>Display outputs.</p>
<div class="sourceCode" id="cb49"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/pkg/MCMCvis/man/MCMCsummary.html">MCMCsummary</a></span><span class="op">(</span>object <span class="op">=</span> <span class="va">mcmc.output</span>, round <span class="op">=</span> <span class="fl">2</span><span class="op">)</span>
<span class="co">##                 mean   sd 2.5%  50% 97.5% Rhat n.eff</span>
<span class="co">## life_expectancy 2.80 2.35 1.07 1.22  6.12  Inf     0</span>
<span class="co">## theta           0.56 0.21 0.39 0.44  0.85  Inf     0</span></code></pre></div>
<p>Helpful when object format unusual for NIMBLE, like spatial object. Global environment. <strong>Uncomment for more details</strong>
<!-- "In general if you do need a nimbleRcall like this, there are a couple of considerations. It is common to need to write a wrapper function, i.e. a function you access via nimbleRcall that calls your actual function of interest with arguments and then return value rearranged as needed. For example, if you just need the eigenvectors, a wrapper function could pick those out and return them.  The bigger issue is the returnType declaration: nimble type declarations do not include an R list of type declarations as a nimble type.  I think you could use a nimbleList data structure for this purpose.  You would have to create a nimbleList type and then use that as the declared returnType.  But you would still need to write a wrapper, so that you could convert the list returned from base::eigen into a nimbleList object to return from your wrapper.". See also https://kenkellner.com/blog/models-with-integrals.html. --></p>
<p>In the same spirit, you can write your own distribution and use it in your model with NIMBLE. This is outside the scope of this book, and I refer to the NIMBLE manual at <a href="https://r-nimble.org/html_manual/cha-user-defined.html#sec:user-distributions" class="uri">https://r-nimble.org/html_manual/cha-user-defined.html#sec:user-distributions</a> for further details and examples.</p>
</div>
<div id="behind-the-hood" class="section level2" number="2.5">
<h2>
<span class="header-section-number">2.5</span> Behind the hood<a class="anchor" aria-label="anchor" href="#behind-the-hood"><i class="fas fa-link"></i></a>
</h2>
<p>Our workflow so far.</p>
<p>But <code>nimble</code> gives full access to the MCMC engine</p>
<p>The <code><a href="https://rdrr.io/pkg/nimble/man/nimbleMCMC.html">nimbleMCMC()</a></code> interface runs the “default” MCMC, which precludes any customization of the MCMC sampling algorithms. This is fine for most use, but in some situations useful to know what’s behind the hood. The workflow to use is: <code><a href="https://rdrr.io/pkg/nimble/man/nimbleModel.html">nimbleModel()</a></code>, <code><a href="https://rdrr.io/pkg/nimble/man/configureMCMC.html">configureMCMC()</a></code>, <code><a href="https://rdrr.io/pkg/nimble/man/buildMCMC.html">buildMCMC()</a></code>, <code><a href="https://rdrr.io/pkg/nimble/man/compileNimble.html">compileNimble()</a></code> and <code><a href="https://rdrr.io/pkg/nimble/man/runMCMC.html">runMCMC()</a></code>. Why is it useful? <strong>Go through example again. Show how to debug. Move stuff from Speed here.</strong></p>
<p>Steps to use NIMBLE at full capacity
Build the model. It is an R object.
Build the MCMC.
Compile the model and MCMC.
Run the MCMC.
Extract the samples.</p>
<p>nimbleMCMC does all of this at once.</p>
<p>Why is it useful? First, helps you debug. Second, play around with samplers. Change default, or write your own.</p>
<div id="debug" class="section level3" number="2.5.1">
<h3>
<span class="header-section-number">2.5.1</span> Debug<a class="anchor" aria-label="anchor" href="#debug"><i class="fas fa-link"></i></a>
</h3>
</div>
<div id="change-default-sampler" class="section level3" number="2.5.2">
<h3>
<span class="header-section-number">2.5.2</span> Change default sampler<a class="anchor" aria-label="anchor" href="#change-default-sampler"><i class="fas fa-link"></i></a>
</h3>
</div>
<div id="code-your-own-sampler" class="section level3" number="2.5.3">
<h3>
<span class="header-section-number">2.5.3</span> Code your own sampler<a class="anchor" aria-label="anchor" href="#code-your-own-sampler"><i class="fas fa-link"></i></a>
</h3>
<div class="sourceCode" id="cb50"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">model</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/nimble/man/nimbleCode.html">nimbleCode</a></span><span class="op">(</span><span class="op">{</span>
  <span class="co"># likelihood</span>
  <span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">released</span><span class="op">)</span><span class="op">{</span>
    <span class="va">survived</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">~</span> <span class="fu">dbern</span><span class="op">(</span><span class="va">theta</span><span class="op">)</span>
  <span class="op">}</span>
  <span class="co"># prior</span>
  <span class="va">theta</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">dunif</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span>
  <span class="va">life_expectancy</span> <span class="op">&lt;-</span> <span class="fu">Rcalculate_life_expectancy</span><span class="op">(</span><span class="va">theta</span><span class="op">)</span>
<span class="op">}</span><span class="op">)</span>
<span class="va">my.data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>survived <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/nimble/man/nimble-R-functions.html">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/nimble/man/nimble-R-functions.html">rep</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">19</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/pkg/nimble/man/nimble-R-functions.html">rep</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">57</span><span class="op">-</span><span class="fl">19</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
<span class="va">my.constants</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>released <span class="op">=</span> <span class="fl">57</span><span class="op">)</span>
<span class="va">parameters.to.save</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/nimble/man/nimble-R-functions.html">c</a></span><span class="op">(</span><span class="st">"theta"</span>, <span class="st">"life_expectancy"</span><span class="op">)</span>
<span class="va">initial.values</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>theta <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">0</span>,<span class="fl">1</span><span class="op">)</span><span class="op">)</span>
<span class="va">n.iter</span> <span class="op">&lt;-</span> <span class="fl">5000</span>
<span class="va">n.burnin</span> <span class="op">&lt;-</span> <span class="fl">1000</span>
<span class="va">n.chains</span> <span class="op">&lt;-</span> <span class="fl">3</span>
<span class="va">mcmc.output</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/nimble/man/nimbleMCMC.html">nimbleMCMC</a></span><span class="op">(</span>code <span class="op">=</span> <span class="va">model</span>,
                          data <span class="op">=</span> <span class="va">my.data</span>,
                          constants <span class="op">=</span> <span class="va">my.constants</span>,
                          inits <span class="op">=</span> <span class="va">initial.values</span>,
                          monitors <span class="op">=</span> <span class="va">parameters.to.save</span>,
                          niter <span class="op">=</span> <span class="va">n.iter</span>,
                          nburnin <span class="op">=</span> <span class="va">n.burnin</span>,
                          nchains <span class="op">=</span> <span class="va">n.chains</span><span class="op">)</span>
<span class="co">## |-------------|-------------|-------------|-------------|</span>
<span class="co">## |-------------------------------------------------------|</span>
<span class="co">## |-------------|-------------|-------------|-------------|</span>
<span class="co">## |-------------------------------------------------------|</span>
<span class="co">## |-------------|-------------|-------------|-------------|</span>
<span class="co">## |-------------------------------------------------------|</span>
<span class="fu"><a href="https://rdrr.io/pkg/MCMCvis/man/MCMCsummary.html">MCMCsummary</a></span><span class="op">(</span>object <span class="op">=</span> <span class="va">mcmc.output</span>, round <span class="op">=</span> <span class="fl">2</span><span class="op">)</span>
<span class="co">##                 mean   sd 2.5%  50% 97.5% Rhat n.eff</span>
<span class="co">## life_expectancy 0.94 0.16 0.68 0.92  1.29    1  2777</span>
<span class="co">## theta           0.34 0.06 0.23 0.34  0.46    1  2798</span></code></pre></div>
<p>Your own Metropolis. <strong>Introduce nimbleFunction earlier <a href="https://r-nimble.org/html_manual/cha-user-defined.html#sec:user-functions" class="uri">https://r-nimble.org/html_manual/cha-user-defined.html#sec:user-functions</a></strong></p>
<div class="sourceCode" id="cb51"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">my_metropolis</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/nimble/man/nimbleFunction.html">nimbleFunction</a></span><span class="op">(</span>
  name <span class="op">=</span> <span class="st">'my_metropolis'</span>,
  contains <span class="op">=</span> <span class="va">sampler_BASE</span>,
  setup <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">model</span>, <span class="va">mvSaved</span>, <span class="va">target</span>, <span class="va">control</span><span class="op">)</span> <span class="op">{</span>
    <span class="va">calcNodes</span> <span class="op">&lt;-</span> <span class="va">model</span><span class="op">$</span><span class="fu">getDependencies</span><span class="op">(</span><span class="va">target</span><span class="op">)</span>
    <span class="va">scale</span> <span class="op">&lt;-</span> <span class="va">control</span><span class="op">$</span><span class="va">scale</span>
  <span class="op">}</span>,
  run <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="op">{</span>
    <span class="va">initialLP</span> <span class="op">&lt;-</span> <span class="va">model</span><span class="op">$</span><span class="fu">getLogProb</span><span class="op">(</span><span class="va">calcNodes</span><span class="op">)</span>
    <span class="va">current</span> <span class="op">&lt;-</span> <span class="va">model</span><span class="op">[[</span><span class="va">target</span><span class="op">]</span><span class="op">]</span>
    <span class="va">lcurrent</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="va">current</span> <span class="op">/</span> <span class="op">(</span><span class="fl">1</span> <span class="op">-</span> <span class="va">current</span><span class="op">)</span><span class="op">)</span>
    <span class="va">lproposal</span> <span class="op">&lt;-</span> <span class="va">lcurrent</span>  <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">0</span>, <span class="va">scale</span><span class="op">)</span>
    <span class="va">proposal</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Logistic.html">plogis</a></span><span class="op">(</span><span class="va">lproposal</span><span class="op">)</span>
    <span class="va">model</span><span class="op">[[</span><span class="va">target</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;&lt;-</span> <span class="va">proposal</span>
    <span class="va">proposalLP</span> <span class="op">&lt;-</span> <span class="va">model</span><span class="op">$</span><span class="fu">calculate</span><span class="op">(</span><span class="va">calcNodes</span><span class="op">)</span>
    <span class="va">lMHR</span> <span class="op">&lt;-</span> <span class="va">proposalLP</span> <span class="op">-</span> <span class="va">initialLP</span>
    <span class="kw">if</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">0</span>,<span class="fl">1</span><span class="op">)</span> <span class="op">&lt;</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span><span class="op">(</span><span class="va">lMHR</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
      <span class="co">## accept</span>
      <span class="fu"><a href="https://rdrr.io/pkg/nimble/man/nimCopy.html">copy</a></span><span class="op">(</span>from <span class="op">=</span> <span class="va">model</span>, to <span class="op">=</span> <span class="va">mvSaved</span>, nodes <span class="op">=</span> <span class="va">calcNodes</span>, logProb <span class="op">=</span> <span class="cn">TRUE</span>, row <span class="op">=</span> <span class="fl">1</span><span class="op">)</span>
    <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span>
      <span class="co">## reject</span>
      <span class="fu"><a href="https://rdrr.io/pkg/nimble/man/nimCopy.html">copy</a></span><span class="op">(</span>from <span class="op">=</span> <span class="va">mvSaved</span>, to <span class="op">=</span> <span class="va">model</span>, nodes <span class="op">=</span> <span class="va">calcNodes</span>, logProb <span class="op">=</span> <span class="cn">TRUE</span>, row <span class="op">=</span> <span class="fl">1</span><span class="op">)</span>
    <span class="op">}</span>
  <span class="op">}</span>,
  methods <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>
    reset <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="op">{</span><span class="op">}</span>
  <span class="op">)</span>
<span class="op">)</span></code></pre></div>
<p>Parameter to tune. Seek equivalent in previous chapter.</p>
<div class="sourceCode" id="cb52"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">scale</span> <span class="op">&lt;-</span> <span class="fl">0.05</span></code></pre></div>
<p>Detailed workflow.</p>
<div class="sourceCode" id="cb53"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">Rmodel</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/nimble/man/nimbleModel.html">nimbleModel</a></span><span class="op">(</span><span class="va">model</span>, <span class="va">my.constants</span>, <span class="va">my.data</span>, <span class="fu">initial.values</span><span class="op">(</span><span class="op">)</span><span class="op">)</span>
<span class="va">conf</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/nimble/man/configureMCMC.html">configureMCMC</a></span><span class="op">(</span><span class="va">Rmodel</span>, monitors <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/nimble/man/nimble-R-functions.html">c</a></span><span class="op">(</span><span class="st">'theta'</span><span class="op">)</span><span class="op">)</span>
<span class="co">## ===== Monitors =====</span>
<span class="co">## thin = 1: theta</span>
<span class="co">## ===== Samplers =====</span>
<span class="co">## RW sampler (1)</span>
<span class="co">##   - theta</span>
<span class="va">conf</span><span class="op">$</span><span class="fu">printSamplers</span><span class="op">(</span><span class="op">)</span>
<span class="co">## [1] RW sampler: theta</span>
<span class="va">conf</span><span class="op">$</span><span class="fu">printSamplers</span><span class="op">(</span>byType <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
<span class="co">## RW sampler (1)</span>
<span class="co">##   - theta</span>
<span class="va">conf</span><span class="op">$</span><span class="fu">removeSamplers</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/nimble/man/nimble-R-functions.html">c</a></span><span class="op">(</span><span class="st">'theta'</span><span class="op">)</span><span class="op">)</span>
<span class="va">conf</span><span class="op">$</span><span class="fu">addSampler</span><span class="op">(</span>target <span class="op">=</span> <span class="st">'theta'</span>, type <span class="op">=</span> <span class="st">'my_metropolis'</span>, control <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>scale <span class="op">=</span> <span class="va">scale</span><span class="op">)</span><span class="op">)</span>
<span class="va">conf</span><span class="op">$</span><span class="fu">printSamplers</span><span class="op">(</span><span class="op">)</span>
<span class="co">## [1] my_metropolis sampler: theta,  scale: 0.050000000000000003</span>
<span class="va">conf</span><span class="op">$</span><span class="fu">printMonitors</span><span class="op">(</span><span class="op">)</span>
<span class="co">## thin = 1: theta</span>
<span class="va">Rmcmc</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/nimble/man/buildMCMC.html">buildMCMC</a></span><span class="op">(</span><span class="va">conf</span><span class="op">)</span>
<span class="va">out</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/nimble/man/compileNimble.html">compileNimble</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>model <span class="op">=</span> <span class="va">Rmodel</span>, mcmc <span class="op">=</span> <span class="va">Rmcmc</span><span class="op">)</span><span class="op">)</span>
<span class="va">Cmcmc</span> <span class="op">&lt;-</span> <span class="va">out</span><span class="op">$</span><span class="va">mcmc</span>
<span class="va">samples</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/nimble/man/runMCMC.html">runMCMC</a></span><span class="op">(</span><span class="va">Cmcmc</span>, niter <span class="op">=</span> <span class="fl">5000</span>, nburnin <span class="op">=</span> <span class="fl">1000</span><span class="op">)</span>
<span class="co">## |-------------|-------------|-------------|-------------|</span>
<span class="co">## |-------------------------------------------------------|</span>
<span class="fu"><a href="https://rdrr.io/pkg/nimble/man/nimble-internal.html">samplesSummary</a></span><span class="op">(</span><span class="va">samples</span><span class="op">)</span>
<span class="co">##        Mean Median St.Dev. 95%CI_low 95%CI_upp</span>
<span class="co">## theta 0.345 0.3433 0.06199    0.2232     0.476</span>
<span class="co">#chainsPlot(samples)</span></code></pre></div>
<p>Change parameter to tune.</p>
<div class="sourceCode" id="cb54"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">scale</span> <span class="op">&lt;-</span> <span class="fl">2</span>
<span class="va">Rmodel</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/nimble/man/nimbleModel.html">nimbleModel</a></span><span class="op">(</span><span class="va">model</span>, <span class="va">my.constants</span>, <span class="va">my.data</span>, <span class="fu">initial.values</span><span class="op">(</span><span class="op">)</span><span class="op">)</span>
<span class="va">conf</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/nimble/man/configureMCMC.html">configureMCMC</a></span><span class="op">(</span><span class="va">Rmodel</span>, monitors <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/nimble/man/nimble-R-functions.html">c</a></span><span class="op">(</span><span class="st">'theta'</span><span class="op">)</span><span class="op">)</span>
<span class="co">## ===== Monitors =====</span>
<span class="co">## thin = 1: theta</span>
<span class="co">## ===== Samplers =====</span>
<span class="co">## RW sampler (1)</span>
<span class="co">##   - theta</span>
<span class="va">conf</span><span class="op">$</span><span class="fu">printSamplers</span><span class="op">(</span><span class="op">)</span>
<span class="co">## [1] RW sampler: theta</span>
<span class="va">conf</span><span class="op">$</span><span class="fu">printSamplers</span><span class="op">(</span>byType <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
<span class="co">## RW sampler (1)</span>
<span class="co">##   - theta</span>
<span class="va">conf</span><span class="op">$</span><span class="fu">removeSamplers</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/nimble/man/nimble-R-functions.html">c</a></span><span class="op">(</span><span class="st">'theta'</span><span class="op">)</span><span class="op">)</span>
<span class="va">conf</span><span class="op">$</span><span class="fu">addSampler</span><span class="op">(</span>target <span class="op">=</span> <span class="st">'theta'</span>, type <span class="op">=</span> <span class="st">'my_metropolis'</span>, control <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>scale <span class="op">=</span> <span class="va">scale</span><span class="op">)</span><span class="op">)</span>
<span class="va">conf</span><span class="op">$</span><span class="fu">printSamplers</span><span class="op">(</span><span class="op">)</span>
<span class="co">## [1] my_metropolis sampler: theta,  scale: 2</span>
<span class="va">conf</span><span class="op">$</span><span class="fu">printMonitors</span><span class="op">(</span><span class="op">)</span>
<span class="co">## thin = 1: theta</span>
<span class="va">Rmcmc</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/nimble/man/buildMCMC.html">buildMCMC</a></span><span class="op">(</span><span class="va">conf</span><span class="op">)</span>
<span class="va">out</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/nimble/man/compileNimble.html">compileNimble</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>model <span class="op">=</span> <span class="va">Rmodel</span>, mcmc <span class="op">=</span> <span class="va">Rmcmc</span><span class="op">)</span><span class="op">)</span>
<span class="va">Cmcmc</span> <span class="op">&lt;-</span> <span class="va">out</span><span class="op">$</span><span class="va">mcmc</span>
<span class="va">samples</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/nimble/man/runMCMC.html">runMCMC</a></span><span class="op">(</span><span class="va">Cmcmc</span>, niter <span class="op">=</span> <span class="fl">5000</span>, nburnin <span class="op">=</span> <span class="fl">1000</span><span class="op">)</span>
<span class="co">## |-------------|-------------|-------------|-------------|</span>
<span class="co">## |-------------------------------------------------------|</span>
<span class="fu"><a href="https://rdrr.io/pkg/nimble/man/nimble-internal.html">samplesSummary</a></span><span class="op">(</span><span class="va">samples</span><span class="op">)</span>
<span class="co">##        Mean Median St.Dev. 95%CI_low 95%CI_upp</span>
<span class="co">## theta 0.337 0.3355 0.05917    0.2186    0.4564</span>
<span class="co">#chainsPlot(samples)</span></code></pre></div>
<p>Draw parallel with previous chapter.</p>
</div>
</div>
<div id="tip-and-tricks" class="section level2" number="2.6">
<h2>
<span class="header-section-number">2.6</span> Tip and tricks<a class="anchor" aria-label="anchor" href="#tip-and-tricks"><i class="fas fa-link"></i></a>
</h2>
<p>Main problems ans solutions. Call to community.</p>
<p>Flexible specification of distributions</p>
<div class="sourceCode" id="cb55"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># JAGS (&amp; Nimble)</span>
<span class="kw">for</span><span class="op">(</span><span class="va">t</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">Tmax</span><span class="op">)</span><span class="op">{</span>
  <span class="va">epsilon</span><span class="op">[</span><span class="va">t</span><span class="op">]</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">dnorm</a></span><span class="op">(</span><span class="fl">0</span>, <span class="va">tau</span><span class="op">)</span>
<span class="op">}</span>
<span class="va">tau</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/nimble/man/nimble-math.html">pow</a></span><span class="op">(</span><span class="va">sigma</span>, <span class="op">-</span><span class="fl">2</span><span class="op">)</span>
<span class="va">sigma</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">dunif</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">5</span><span class="op">)</span>

<span class="co"># Nimble</span>
<span class="kw">for</span><span class="op">(</span><span class="va">t</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">Tmax</span><span class="op">)</span><span class="op">{</span>
  <span class="va">epsilon</span><span class="op">[</span><span class="va">t</span><span class="op">]</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">dnorm</a></span><span class="op">(</span><span class="fl">0</span>, sd <span class="op">=</span> <span class="va">sigma</span><span class="op">)</span>
<span class="op">}</span>
<span class="va">sigma</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">dunif</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">5</span><span class="op">)</span></code></pre></div>
<p>The end of empty indices</p>
<div class="sourceCode" id="cb56"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># JAGS</span>
<span class="va">sum.x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">x</span><span class="op">[</span><span class="op">]</span><span class="op">)</span>

<span class="co"># Nimble</span>
<span class="va">sum.x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">x</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="va">Tmax</span><span class="op">]</span><span class="op">)</span></code></pre></div>
<p>Try using “calculate=FALSE” in the call to nimbleModel. For such a large model, the uncompiled calculation can be a substantial portion of the time. When you get to configureMCMC, try using “useConjugacy=FALSE” to make that faster.</p>
<p>Thanks for posting. As a quick reply, please try using “calculate = FALSE” in the call to nimbleModel.</p>
<p>By default (calculate = TRUE), nimbleModel iterates through every node of the model, in order, trying to calculate, which means calculating values for deterministic nodes and log probabilities for stochastic nodes. For large models, this can take a long time because it is uncompiled and also doing some laborious keeping track of model structure. It can be helpful for debugging or catching issues, but it isn’t strictly necessary.</p>
<p>Non-parametric?</p>
<p>The NA or NaN messages are saying that the log probability calculation for a node is not valid.  That usually means not that the input data for the node is invalid but that some initial values for its parent nodes are giving an invalid probability. This may or may not be a problem. The MCMC does try to initialize everything. A good way to diagnose issues is to run the MCMC for 0 iterations (which will trigger the initialization) and then inspect the compiled model object.  For example, if it is called Cmodel, you can do:</p>
<p>Cmodel<span class="math inline">\(calculate("y[5, 10]") # perhaps this is NA # Then inspect parent nodes to see how this is happening: Cmodel\)</span>beta1[5, 10] # etc.</p>
<p>here a couple of tips. A first tip would be to use the argument calculate = FALSE when using the nimbleModel() function, which will build the nimble models faster. By default, calculate is set to TRUE, meaning that nimble calculates all deterministic nodes and logProbability values when creating the model, and with large models this can eat up a good amount of time and memory.</p>
<p>Second, it may be helpful in this case to write Z and prob in a vectorized form; this should help in that the resulting model would have less nodes to handle (i.e. two vector nodes instead of 2xn scalar nodes). To do so, you would need a user-defined distribution for the vectorized version of the Bernoulli variable, that takes a vector of probabilities and returns the total log-probability. If you are not familiar with user-defined distributions, they are covered in Chapter 12.2 of the User Manual, plus there are a couple of examples using them in our examples page on the website (“Writing a new distribution” and the “stochastic volatility” ones). And of course, feel free to ask for clarifications here!</p>
<p>Back to your needs: Here is a way to work around some of nimble’s scaling issues. You can use nimbleRcall to keep large constant objects entirely out of the model. In the example below, I have kept X and pCov out of the model. In effect, nimble is still managing the model graph and using its MCMC system, but some of the big calculations are thrown back to R. There will be some overhead from going back to R, but maybe those costs won’t be too bad compared to the cost of the large calculations. Of course, I don’t know if you want to expand the model to have X and/or pCov be non-constant, but if so you can build on the basic scheme shown below. It would also be possible to have the large objects like X and pCov be in C++ objects used by C++ functions via nimbleExternalCall, but that would take some direct C++ coding.</p>
<p>The warnings about variables not being fully initialized are just that, warnings, not errors.  A difference from JAGS is that you do not need all inits and data to be set up when you call nimbleModel, although many find it convenient to do so.  By default, nimbleModel tries calculating the entire model and lets you know if anything is not initialized, in case you thought it was fully initialized.  If you don’t want it to do this (e.g. after you have your workflow working smoothly), you can do ‘calculate=FALSE’ in the nimbleModel call.</p>
<p>If you run MCMC with incomplete initial values, it might work or it might not.  You may get those warnings from a full calculation at the start and then it might run fine.  The MCMC will try to initialize a node that is NA by drawing from its prior.  In some models, that value can make something that depends on it invalid, with a log probability of -Inf, if the value of one node determines the valid range of values for another.  Sometimes the MCMC will successfully mix its way out of invalid initial states, sometimes not.  In summary, if you get a slew of warnings, and then they stop, and then you get reasonable MCMC results, you are probably fine.  Either way, many people find it helpful to achieve full initialization.  The nodes that need to be initialized are stochastic nodes.  A related issue is that even if drawing initial values from priors does not give warnings or errors, those are often not very good initial values.</p>
<p>From reading your code, I am not quickly seeing what nodes are not fully initialized.  You can use the model object to debug the situation.  For example, if the messages are telling you that survNT is not fully initialized, you can do:</p>
<p>model<span class="math inline">\(survNT # look at the values model\)</span>calculate(‘survNT’) # look at their log probability sum
model$calculate(‘survNT[3]’) # one by one if needed
(assuming “model” is from model &lt;- nimbleModel(<your inputs>)</your></p>
<p>If the problem is further down and unclear where, you can do something like this:</p>
<p>for(yNode in model<span class="math inline">\(expandNodeNames('y')) {   logProb &lt;- model\)</span>calculate(yNode)
  cat(paste(“logProb for,” yNode, “=,” logProb))
}</p>
<p>If you determine a specific yNode has an invalid logProb, you can check its inputs:</p>
<p>model<span class="math inline">\(po[&lt;indices as needed&gt;] model\)</span>z</p>
<p>and so on.</p>
<p>First step, not the problem: after you build the model (nimbleModel), Rmodel<span class="math inline">\(calculate() returns NA.  This is not necessarily an error but indicates incomplete initialization, which may later be filled in manually or by the MCMC drawing from priors. # I explored like this: Rmodel\)</span>calculate() #NA
for(v in Rmodel<span class="math inline">\(getVarNames())   print(paste(v, Rmodel\)</span>calculate(v)))
for(node in Rmodel<span class="math inline">\(expandNodeNames("state"))   print(paste(node, Rmodel\)</span>calculate(node)))
Rmodel<span class="math inline">\(gamma_Matrix Rmodel\)</span>temp</p>
<p>nimbleRcall is a way to pass control back to an R function, even from compiled nimble code.  It does impose the overhead of using the R evaluator, much slower than compiled C++, but possibly not a problem for a quick step.  If speed becomes an issue, you could also do it via a nimbleExternalCall, which can call separately compiled code, if you get set up to use an eigen decomposition outside of nimble.</p>
<p>NIMBLE is much more than MCMC sampler. Model ^rogrammaing language.</p>
<p>Parallelization <a href="https://r-nimble.org/nimbleExamples/parallelizing_NIMBLE.html" class="uri">https://r-nimble.org/nimbleExamples/parallelizing_NIMBLE.html</a> When you follow the code in that example of running chains in parallel, one is simply setting a different seed for each chain. This is similar to JAGS once JAGS gets to a fifth chain (after using different generators for the first four).
By default, runMCMC and nimbleMCMC just have the random number generation for each chain pick up where the previous chain left off, which of course guarantees independence. But if you use setSeed, then that will also set different seeds for each chain.</p>
<p>In general, setting different seeds is very likely to be fine. It’s hard to find reliable information about this, but my understanding is that different seeds should be quite far apart in the period sequence that random numbers generate. That said, it’s possible that the pseudo-random numbers for two chains could overlap, but if this happened, it would happen such that the initial random numbers for one chain occurred at some point later in the sequence of numbers for the second chain. I doubt that this would cause any impactful dependence given that an MCMC will depend in a complex way on the full history of the chain.</p>
<p>Tomas, if you’ve already used runMCMC(Cmcmc, …), then yes, you can still extend the current MCMC chain, using:</p>
<p>Cmcmc$run(niter, reset = FALSE)</p>
<p>where niter is the number of additional MCMC iterations you wish to run.  After that, you can extract the full maxtrix of MCMC samples (which will include the ones you previously executed in the first call of runMCMC), using:</p>
<p>full_matrix_of_samples &lt;- as.matrix(Cmcmc$mvSamples)</p>
</div>
<div id="summary-1" class="section level2" number="2.7">
<h2>
<span class="header-section-number">2.7</span> Summary<a class="anchor" aria-label="anchor" href="#summary-1"><i class="fas fa-link"></i></a>
</h2>
<ul>
<li><p>Blabla.</p></li>
<li><p>Reblabla.</p></li>
</ul>
</div>
<div id="suggested-reading-1" class="section level2" number="2.8">
<h2>
<span class="header-section-number">2.8</span> Suggested reading<a class="anchor" aria-label="anchor" href="#suggested-reading-1"><i class="fas fa-link"></i></a>
</h2>
<ul>
<li><p>Official website <a href="https://r-nimble.org">https://r-nimble.org</a></p></li>
<li><p>User Manual <a href="https://r-nimble.org/html_manual/cha-welcome-nimble.html">https://r-nimble.org/html_manual/cha-welcome-nimble.html</a> and <a href="https://r-nimble.org/cheatsheets/NimbleCheatSheet.pdf">cheatsheet</a>.</p></li>
<li><p>Users mailing list <a href="https://groups.google.com/forum/#!forum/nimble-users">https://groups.google.com/forum/#!forum/nimble-users</a></p></li>
<li><p>Training material <a href="https://github.com/nimble-training">https://github.com/nimble-training</a></p></li>
<li><p>Reference to cite when using nimble in a publication:</p></li>
</ul>
<blockquote>
<p>de Valpine, P., D. Turek, C. J. Paciorek, C. Anderson-Bergman, D. Temple Lang, and R. Bodik (2017). <a href="https://arxiv.org/pdf/1505.05093.pdf">Programming With Models: Writing Statistical Algorithms for General Model Structures With NIMBLE</a>. <em>Journal of Computational and Graphical Statistics</em> <strong>26</strong> (2): 403–13.</p>
</blockquote>
<!-- ## A dire quelque part? -->
<!-- Pourquoi Nimble plutôt que Stan? Syntaxe BUGS, also discrete latent states easier to deal with, no need to marginalise. In Stan you marginalise (ref forward to relevant section of the book), but difficult endeavour, and you do not need to do that with NIMBLE, it has algorithms that work fine with discrete latent states.  -->
<!-- What about vectorization? -->
<!-- And parallelization à la jagsUI? -->
<!-- Simulations also? Generate initial values, cf code Maud? -->

</div>
</div>

  <div class="chapter-nav">
<div class="prev"><a href="crashcourse.html"><span class="header-section-number">1</span> Bayesian statistics &amp; MCMC</a></div>
<div class="next"><a href="hmmcapturerecapture.html"><span class="header-section-number">3</span> Hidden Markov models</a></div>
</div></main><div class="col-md-3 col-lg-2 d-none d-md-block sidebar sidebar-chapter">
    <nav id="toc" data-toggle="toc" aria-label="On this page"><h2>On this page</h2>
      <ul class="nav navbar-nav">
<li><a class="nav-link" href="#intronimble"><span class="header-section-number">2</span> NIMBLE tutorial</a></li>
<li><a class="nav-link" href="#introduction-2"><span class="header-section-number">2.1</span> Introduction</a></li>
<li><a class="nav-link" href="#what-is-nimble"><span class="header-section-number">2.2</span> What is NIMBLE?</a></li>
<li><a class="nav-link" href="#getting-started"><span class="header-section-number">2.3</span> Getting started</a></li>
<li><a class="nav-link" href="#functions-in-nimble"><span class="header-section-number">2.4</span> Functions in NIMBLE</a></li>
<li>
<a class="nav-link" href="#behind-the-hood"><span class="header-section-number">2.5</span> Behind the hood</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#debug"><span class="header-section-number">2.5.1</span> Debug</a></li>
<li><a class="nav-link" href="#change-default-sampler"><span class="header-section-number">2.5.2</span> Change default sampler</a></li>
<li><a class="nav-link" href="#code-your-own-sampler"><span class="header-section-number">2.5.3</span> Code your own sampler</a></li>
</ul>
</li>
<li><a class="nav-link" href="#tip-and-tricks"><span class="header-section-number">2.6</span> Tip and tricks</a></li>
<li><a class="nav-link" href="#summary-1"><span class="header-section-number">2.7</span> Summary</a></li>
<li><a class="nav-link" href="#suggested-reading-1"><span class="header-section-number">2.8</span> Suggested reading</a></li>
</ul>

      <div class="book-extra">
        <ul class="list-unstyled">
<li><a id="book-source" href="https://github.com/oliviergimenez/banana-book/blob/master/nimble.Rmd">View source <i class="fab fa-github"></i></a></li>
          <li><a id="book-edit" href="https://github.com/oliviergimenez/banana-book/edit/master/nimble.Rmd">Edit this page <i class="fab fa-github"></i></a></li>
        </ul>
</div>
    </nav>
</div>

</div>
</div> <!-- .container -->

<footer class="bg-primary text-light mt-5"><div class="container"><div class="row">

  <div class="col-12 col-md-6 mt-3">
    <p>"<strong>Bayesian Analysis of Capture-Recapture Data with Hidden Markov Models</strong>: Theory and Case Studies in R" was written by Olivier Gimenez. It was last built on 2022-01-27.</p>
  </div>

  <div class="col-12 col-md-6 mt-3">
    <p>This book was built by the <a class="text-light" href="https://bookdown.org">bookdown</a> R package.</p>
  </div>

</div></div>
</footer><!-- dynamically load mathjax for compatibility with self-contained --><script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script><script type="text/x-mathjax-config">const popovers = document.querySelectorAll('a.footnote-ref[data-toggle="popover"]');
for (let popover of popovers) {
  const div = document.createElement('div');
  div.setAttribute('style', 'position: absolute; top: 0, left:0; width:0, height:0, overflow: hidden; visibility: hidden;');
  div.innerHTML = popover.getAttribute('data-content');

  var has_math = div.querySelector("span.math");
  if (has_math) {
    document.body.appendChild(div);
    MathJax.Hub.Queue(["Typeset", MathJax.Hub, div]);
    MathJax.Hub.Queue(function() {
      popover.setAttribute('data-content', div.innerHTML);
      document.body.removeChild(div);
    })
  }
}
</script>
</body>
</html>
